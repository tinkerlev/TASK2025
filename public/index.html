<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כלי חילוץ וניהול משימות מסיכומי ישיבות - גרסה משופרת</title>
    <link rel="icon" type="image/x-icon" href="/appicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f7ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-label {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            font-weight: 500;
        }

        .upload-label:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
        }

        .processing {
            padding: 20px;
            text-align: center;
            display: none;
        }
        
        .processing-message {
            margin-top:10px;
            color: #495057;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            padding: 20px; 
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }

        .results-header h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .control-panel-section { 
            margin-bottom: 20px; 
            padding: 20px; 
            background: #f8f9fc; 
            border-radius: 12px; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            flex-wrap: wrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }

        .filters-section h4, .export-import-section h4 { 
            margin:0 10px 0 0;
            font-size: 1.1em;
            color: #495057;
            width: 100%; 
            margin-bottom: 10px;
        }
        
        .filters-section label {
            font-size: 0.95em;
            color: #495057;
            margin-left: 5px;
        }
        
        .filters-section select, .filters-section button {
            padding: 8px 12px; 
            border-radius: 6px; 
            border: 1px solid #ced4da;
            font-size: 0.95em;
        }
        
        .filters-section button {
            background-color: #667eea;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .filters-section button:hover {
            background-color: #5a67d8;
        }
        
        .filters-section button.clear { 
            background-color: #6c757d;
        }
        
        .filters-section button.clear:hover {
            background-color: #5a6268;
        }

        .export-import-section button { 
            padding: 10px 15px; 
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em; 
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px; 
            margin-bottom: 5px;
        }


        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .btn-action { 
            background: none;
            border: none;
            color: #555;
            cursor: pointer;
            padding: 5px;
            font-size: 1.3em; 
            transition: color 0.2s ease;
            line-height: 1; 
        }
        .btn-action:hover {
            color: #667eea;
        }
        .btn-action.btn-delete:hover {
            color: #dc3545;
        }
        .btn-action.btn-priority.priority-low:hover { color: #28a745; }
        .btn-action.btn-priority.priority-medium:hover { color: #ffc107; }
        .btn-action.btn-priority.priority-high:hover { color: #e53e3e; }
        
        .btn-priority { 
             border: none;
        }
        .btn-priority.priority-low .star-icon { color: #28a745; } 
        .btn-priority.priority-medium .star-icon { color: #ffc107; } 
        .btn-priority.priority-high .star-icon { color: #e53e3e; } 
        .star-icon { font-size: 1.1em; } 


        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-calendar { background-color: #28a745; color: white; }
        .btn-calendar:hover { background-color: #218838; }
        .btn-ics { background-color: #007bff; color: white; } 
        .btn-ics:hover { background-color: #0056b3; }
        .btn-reminder { background-color: #17a2b8; color: white; }
        .btn-reminder:hover { background-color: #138496; }
        .btn-export { background-color: #20c997; color: white; } 
        .btn-export:hover { background-color: #1ba77e; }
        .btn-import { background-color: #fd7e14; color: white; } 
        .btn-import:hover { background-color: #e56b00; }
        
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .tasks-table:last-child {
            margin-bottom: 0;
        }

        .tasks-table th, .tasks-table td {
            padding: 10px; 
            text-align: right;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        .tasks-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 0.95em; 
        }
        
        .tasks-table td.action-cell {
            text-align: center;
            white-space: nowrap;
        }
        .tasks-table td.selection-cell, .tasks-table th.selection-cell {
            text-align: center;
            vertical-align: middle;
        }

        
        .tasks-table tr.priority-low { background-color: #f0fff4 !important; } 
        .tasks-table tr.priority-medium { background-color: #fffacd !important; } 
        .tasks-table tr.priority-high { background-color: #ffe4e1 !important; } 


        .tasks-table tr:hover {
            background: #f1f5f9; 
        }

        .tasks-table tr:last-child td {
            border-bottom: none;
        }

        .task-number {
            font-weight: bold;
            color: #667eea;
            text-align: center;
        }

        .section-name {
            color: #495057;
            font-weight: 500;
        }
        
        .document-type-label {
            color: #6c757d;
            font-size: 0.85em;
            font-style: italic;
            display: block;
            margin-top: 3px;
        }

        .task-description {
            color: #212529;
            line-height: 1.6;
        }

        .responsible {
            color: #764ba2;
            font-weight: 500;
        }

        .timeline {
            color: #28a745;
            font-weight: 500;
        }
        
        .protocol-date-cell {
            color: #4a5568;
            font-size: 0.9em;
        }

        .no-date {
            color: #dc3545;
            font-style: italic;
        }

        .duplicate-indicator { 
            color: #e53e3e; 
            font-size: 0.8em;
            margin-left: 5px; 
        }


        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 40px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 40px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .file-info {
            background: #e8ebff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-name {
            font-weight: 500;
            color: #667eea;
            margin-bottom: 5px;
        }

        .task-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px; 
            background: #f8f9fc;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-card h4 {
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 40px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: none;
        }

        .debug-section h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .debug-content {
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            color: #495057;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .table-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #667eea;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            .header h1 { font-size: 1.8em; }
            .upload-section, .results-section { padding: 20px; }
            .filters-section { flex-direction: column; gap: 10px; align-items: stretch; }
            .filters-section div { display: flex; flex-direction: column; }
            .filters-section label { margin-bottom: 5px; }
            .filters-section select, .filters-section button { width: 100%; }
            .tasks-table { font-size: 0.9em; }
            .tasks-table th, .tasks-table td { padding: 10px; }
            .action-buttons { flex-direction: column; width: 100%; }
            .btn { width: 100%; justify-content: center; }
            .stats-dashboard { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 כלי חילוץ וניהול משימות מסיכומי ישיבות</h1>
            <p>העלה קובץ Word (או מספר קבצים) לחילוץ אוטומטי של טבלת משימות</p>
            <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.8;">תומך בסיכומי ישיבות הנהלה וישיבות מטה</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📄</div>
                <h3>גרור קבצים לכאן או לחץ לבחירה</h3>
                <p style="margin-top: 10px; color: #666;">קבצים נתמכים: .docx</p>
                <input type="file" id="fileInput" class="file-input" accept=".docx" multiple>
                <label for="fileInput" class="upload-label">בחר קבצים</label>
            </div>
        </div>

        <div class="processing" id="processing">
            <div class="spinner"></div>
            <h3>מעבד קבצים...</h3>
            <p id="processingMessage" class="processing-message"></p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="debug-section" id="debugSection">
            <h3>מידע לאיתור תקלות:</h3>
            <div class="debug-content" id="debugContent"></div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>משימות שחולצו</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="copyClipboardBtn">📋 העתק לזיכרון</button>
                    <button class="btn btn-secondary" id="switchToUploadBtn">🔄 הוסף קבצים נוספים</button>
                    <button class="btn btn-danger" id="clearAllBtn">🗑️ נקה הכל</button>
                </div>
            </div>

            <div class="stats-dashboard" id="statsDashboard">
                <div class="stat-card">
                    <h4>סה"כ משימות</h4>
                    <div class="value" id="statTotal">0</div>
                </div>
                <div class="stat-card">
                    <h4>משימות עם תעדוף</h4>
                    <div class="value" id="statPrioritized">0</div>
                </div>
                <div class="stat-card">
                    <h4>משימות כפולות</h4>
                    <div class="value" id="statDuplicates">0</div>
                </div>
                <div class="stat-card">
                    <h4>אחראים שונים</h4>
                    <div class="value" id="statResponsibles">0</div>
                </div>
            </div>

            <div class="export-import-section control-panel-section">
                <h4>ייצוא וייבוא נתונים:</h4>
                <button class="btn-export" id="exportExcelBtn">
                    📊 ייצא ל-CSV
                </button>
                <button class="btn-export" id="exportJsonBtn">
                    💾 שמור כ-JSON
                </button>
                <button class="btn-import" id="importJsonBtn">
                    📂 טען מקובץ JSON
                </button>
                <input type="file" id="importFileInput" style="display: none;" accept=".json">
                <button class="btn-export btn-ics" id="exportIcsBtn">
                    📅 ייצא בחירה/הכל ל-Outlook (ics)
                </button>
            </div>
            <div class="filters-section control-panel-section" id="filtersSection">
                <h4>סנן תצוגה:</h4>
                <div>
                    <label for="filterResponsible">לפי אחראי:</label>
                    <select id="filterResponsible"></select>
                </div>
                <div>
                    <label for="filterSection">לפי סעיף/נושא:</label>
                    <select id="filterSection"></select>
                </div>
                <div>
                    <label for="filterTimeline">לפי לוח זמנים:</label>
                    <select id="filterTimeline"></select>
                </div>
                <div>
                    <label for="filterProtocolDate">לפי תאריך פרוטוקול:</label>
                    <select id="filterProtocolDate"></select>
                </div>
                <div>
                    <label for="filterPriority">לפי תעדוף:</label>
                    <select id="filterPriority">
                        <option value="all">הכל</option>
                        <option value="3">גבוה</option>
                        <option value="2">בינוני</option>
                        <option value="1">נמוך</option>
                        <option value="0">ללא</option>
                    </select>
                </div>
                <button id="clearFiltersBtn" class="clear">נקה סינונים</button>
            </div>
            
            <div class="file-info" id="fileInfo"></div>

            <div id="divStaffMeetingTasks" style="display:none;">
                <h3 class="table-title">סיכומי ישיבות מטה</h3>
                <table class="tasks-table" id="tasksTableStaffMeeting">
                    <thead>
                        <tr>
                            <th style="width: 3%;" class="selection-cell"><input type="checkbox" id="selectAllStaffCheckbox" onchange="toggleSelectAll('staff')"></th>
                            <th style="width: 5%;">מס' כללי</th>
                            <th style="width: 18%;">נושא</th>
                            <th style="width: 22%;">משימה</th>
                            <th style="width: 12%;">אחראי</th>
                            <th style="width: 10%;">תאריך פרוטוקול</th>
                            <th style="width: 20%;">פעולות</th> 
                        </tr>
                    </thead>
                    <tbody id="tasksTableBodyStaffMeeting">
                    </tbody>
                </table>
            </div>

            <div id="divManagementTasks" style="display:none;">
                <h3 class="table-title">סיכומי ישיבות הנהלה</h3>
                <table class="tasks-table" id="tasksTableManagement">
                    <thead>
                        <tr>
                            <th style="width: 3%;" class="selection-cell"><input type="checkbox" id="selectAllManagementCheckbox" onchange="toggleSelectAll('management')"></th>
                            <th style="width: 5%;">מס' כללי</th>
                            <th style="width: 12%;">סעיף</th>
                            <th style="width: 15%;">החלטה/המשך טיפול</th>
                            <th style="width: 10%;">אחראי</th>
                            <th style="width: 10%;">לוח זמנים</th>
                            <th style="width: 10%;">תאריך פרוטוקול</th>
                            <th style="width: 25%;">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTableBodyManagement">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // ========================================================================
        // COMPLETE WORKING SCRIPT - NO EXTERNAL DEPENDENCIES
        // ========================================================================

        // --- Global State Variables ---
        let allExtractedTasks = [];
        let currentFilters = { responsible: 'all', section: 'all', timeline: 'all', protocolDate: 'all', priority: 'all' };
        let nextGlobalTaskId = 1;
        let selectedTaskGlobalIds = new Set();

        // --- Constants ---
        const PRIORITY_LEVELS = { NONE: 0, LOW: 1, MEDIUM: 2, HIGH: 3 };
        const PRIORITY_CLASS = { 1: "priority-low", 2: "priority-medium", 3: "priority-high" };
        const PRIORITY_TEXT_MAP = { 0: "⭐", 1: "⭐", 2: "⭐⭐", 3: "⭐⭐⭐" };
        const PRIORITY_TOOLTIP = { 0: "הגדר תעדוף נמוך", 1: "הגדר תעדוף בינוני", 2: "הגדר תעדוף גבוה", 3: "בטל תעדוף" };

        // --- Core Application Logic ---
        async function loadTasksFromServer() {
            try {
                showProcessing();
                const response = await fetch('/api/tasks');
                if (!response.ok) throw new Error('שגיאה בטעינת המשימות');
                
                const tasks = await response.json();
                allExtractedTasks = tasks;
                
                allExtractedTasks.forEach((task, index) => {
                    task.globalId = index + 1; 
                    if (task.priority === undefined) task.priority = PRIORITY_LEVELS.NONE;
                });
                nextGlobalTaskId = allExtractedTasks.length + 1;
                
                hideProcessing();
                
                if (tasks.length > 0) {
                    switchToResultsView();
                    updateStatistics();
                    populateFilterOptions();
                    applyFilters();
                } else {
                    switchToUploadView();
                }
            } catch (error) {
                hideProcessing();
                showError(`שגיאה בטעינת המשימות: ${error.message}`);
                switchToUploadView();
            }
        }

        async function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            showProcessing();
            hideMessages();
            let totalNewTasks = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const processingMsg = document.getElementById('processingMessage');
                if (processingMsg) {
                    processingMsg.textContent = `מעבד קובץ ${i + 1} מתוך ${files.length}: ${file.name}`;
                }
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) throw new Error('שגיאה בהעלאת הקובץ');
                    
                    const result = await uploadResponse.json();
                    const tasksFromFile = extractTasksFromFileContent(result.html, result.filename);
                    
                    if (tasksFromFile.length > 0) {
                        const createResponse = await fetch('/api/tasks/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tasks: tasksFromFile })
                        });
                        
                        if (!createResponse.ok) throw new Error('שגיאה בשמירת המשימות');
                        
                        totalNewTasks += tasksFromFile.length;
                    }
                } catch (error) {
                    hideProcessing();
                    showError(`שגיאה בעיבוד ${file.name}: ${error.message}`);
                    return;
                }
            }

            hideProcessing();
            if (totalNewTasks > 0) {
                showSuccess(`${totalNewTasks} משימות חדשות נוספו ונשמרו!`);
                await loadTasksFromServer();
            } else {
                showSuccess('עיבוד הקבצים הושלם, לא נמצאו משימות חדשות.');
            }
        }

        async function deleteTask(taskId) {
            if (!taskId || !confirm('האם אתה בטוח שברצונך למחוק את המשימה?')) {
                return;
            }
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('שגיאה במחיקת המשימה');
                
                showSuccess("המשימה נמחקה בהצלחה.");
                await loadTasksFromServer();
            } catch (error) {
                showError(`שגיאה במחיקת המשימה: ${error.message}`);
            }
        }

        async function togglePriority(taskId, currentPriority) {
            try {
                const newPriority = (currentPriority + 1) % 4;
                
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priority: newPriority })
                });
                
                if (!response.ok) throw new Error('שגיאה בעדכון עדיפות');
                
                const updatedTask = await response.json();
                
                const taskIndex = allExtractedTasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    allExtractedTasks[taskIndex].priority = updatedTask.priority;
                }
                
                applyFilters();
                updateStatistics();
            } catch (error) {
                showError(`שגיאה בעדכון עדיפות: ${error.message}`);
            }
        }

        async function confirmClearAll() {
            if (confirm("האם אתה בטוח שברצונך למחוק את **כל** המשימות לצמיתות? פעולה זו אינה הפיכה.")) {
                showProcessing();
                const tasksToDelete = allExtractedTasks.map(task => task.id);
                for(const taskId of tasksToDelete){
                    try{
                        await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
                    } catch(e) {
                        console.error("Could not delete task:", taskId, e);
                    }
                }
                allExtractedTasks = [];
                hideProcessing();
                showSuccess("כל המשימות נמחקו.");
                switchToUploadView();
            }
        }

        // --- UI and View Management ---
        function switchToResultsView() {
            const resultsSection = document.getElementById('resultsSection');
            const uploadSection = document.getElementById('uploadSection');
            const filtersSection = document.getElementById('filtersSection');
            
            if (resultsSection) resultsSection.style.display = 'block';
            if (uploadSection) uploadSection.style.display = 'none';
            if (filtersSection) filtersSection.style.display = 'flex';
        }

        function switchToUploadView() {
            const resultsSection = document.getElementById('resultsSection');
            const uploadSection = document.getElementById('uploadSection');
            const filtersSection = document.getElementById('filtersSection');
            
            if (resultsSection) resultsSection.style.display = 'none';
            if (uploadSection) uploadSection.style.display = 'block';
            if (filtersSection) filtersSection.style.display = 'none';
        }

        function showProcessing() { 
            const processing = document.getElementById('processing');
            const uploadSection = document.getElementById('uploadSection');
            const resultsSection = document.getElementById('resultsSection');
            
            if (processing) processing.style.display = 'block';
            if (uploadSection) uploadSection.style.display = 'none';
            if (resultsSection) resultsSection.style.display = 'none';
        }

        function hideProcessing() { 
            const processing = document.getElementById('processing');
            if (processing) processing.style.display = 'none';
        }

        function showError(message) { 
            const el = document.getElementById('errorMessage');
            if (el) {
                el.textContent = message;
                el.style.display = 'block';
            }
            console.error('Error:', message);
        }

        function showSuccess(message) { 
            const el = document.getElementById('successMessage');
            if (el) {
                el.textContent = message;
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 4000);
            }
        }

        function hideMessages() { 
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';
        }

        // --- Data Display and Filtering ---
        function applyFilters() {
            currentFilters.responsible = document.getElementById('filterResponsible').value;
            currentFilters.section = document.getElementById('filterSection').value;
            currentFilters.timeline = document.getElementById('filterTimeline').value;
            currentFilters.protocolDate = document.getElementById('filterProtocolDate').value;
            currentFilters.priority = document.getElementById('filterPriority').value;
            displayResults(getFilteredTasks());
        }

        function getFilteredTasks() {
            return allExtractedTasks.filter(task =>
                (currentFilters.responsible === 'all' || task.responsible === currentFilters.responsible) &&
                (currentFilters.section === 'all' || task.section === currentFilters.section) &&
                (currentFilters.timeline === 'all' || task.timeline === currentFilters.timeline) &&
                (currentFilters.protocolDate === 'all' || task.protocolDate === currentFilters.protocolDate) &&
                (currentFilters.priority === 'all' || task.priority === parseInt(currentFilters.priority))
            );
        }

        function displayResults(tasksToDisplay) {
            const tableBodyManagement = document.getElementById('tasksTableBodyManagement');
            const tableBodyStaff = document.getElementById('tasksTableBodyStaffMeeting');
            tableBodyManagement.innerHTML = '';
            tableBodyStaff.innerHTML = '';

            const managementTasks = tasksToDisplay.filter(t => t.documentType !== 'ישיבת מטה');
            const staffTasks = tasksToDisplay.filter(t => t.documentType === 'ישיבת מטה');
            
            managementTasks.forEach(task => {
                const row = createManagementTaskRow(task);
                tableBodyManagement.appendChild(row);
            });
            
            staffTasks.forEach(task => {
                const row = createStaffTaskRow(task);
                tableBodyStaff.appendChild(row);
            });
            
            document.getElementById('divManagementTasks').style.display = managementTasks.length > 0 ? 'block' : 'none';
            document.getElementById('divStaffMeetingTasks').style.display = staffTasks.length > 0 ? 'block' : 'none';
            
            updateFileInfo(tasksToDisplay);
            updateStatistics();
        }

        function createManagementTaskRow(task) {
            const row = document.createElement('tr');
            row.className = PRIORITY_CLASS[task.priority] || '';
            
            row.innerHTML = `
                <td class="selection-cell"><input type="checkbox" class="task-checkbox" value="${task.globalId}"></td>
                <td class="task-number">${task.globalId}</td>
                <td class="section-name">${task.section || ''}</td>
                <td class="task-description">${task.taskDescription || ''}</td>
                <td class="responsible">${task.responsible || ''}</td>
                <td class="timeline">${task.timeline || ''}</td>
                <td class="protocol-date-cell">${formatDateForDisplay(task.protocolDate)}</td>
                <td class="action-cell">
                    <button class="btn-action btn-priority ${PRIORITY_CLASS[task.priority] || ''}" title="${PRIORITY_TOOLTIP[task.priority]}" onclick="togglePriority('${task.id}', ${task.priority})">
                        <span class="star-icon">${PRIORITY_TEXT_MAP[task.priority]}</span>
                    </button>
                    <button class="btn-action btn-delete" title="מחק משימה" onclick="deleteTask('${task.id}')">🗑️</button>
                </td>
            `;
            return row;
        }

        function createStaffTaskRow(task) {
            const row = document.createElement('tr');
            row.className = PRIORITY_CLASS[task.priority] || '';
            
            row.innerHTML = `
                <td class="selection-cell"><input type="checkbox" class="task-checkbox" value="${task.globalId}"></td>
                <td class="task-number">${task.globalId}</td>
                <td class="section-name">${task.section || ''}</td>
                <td class="task-description">${task.taskDescription || ''}</td>
                <td class="responsible">${task.responsible || ''}</td>
                <td class="protocol-date-cell">${formatDateForDisplay(task.protocolDate)}</td>
                <td class="action-cell">
                    <button class="btn-action btn-priority ${PRIORITY_CLASS[task.priority] || ''}" title="${PRIORITY_TOOLTIP[task.priority]}" onclick="togglePriority('${task.id}', ${task.priority})">
                        <span class="star-icon">${PRIORITY_TEXT_MAP[task.priority]}</span>
                    </button>
                    <button class="btn-action btn-delete" title="מחק משימה" onclick="deleteTask('${task.id}')">🗑️</button>
                </td>
            `;
            return row;
        }

        function updateFileInfo(tasksToDisplay) {
            const fileInfo = document.getElementById('fileInfo');
            const countText = `מציג ${tasksToDisplay.length} מתוך ${allExtractedTasks.length} משימות`;
            fileInfo.innerHTML = `
                <span class="file-name">משימות מהשרת</span>
                <span class="task-count">${countText}</span>
            `;
        }

        function updateStatistics() {
            document.getElementById('statTotal').textContent = allExtractedTasks.length;
            document.getElementById('statPrioritized').textContent = allExtractedTasks.filter(t => t.priority > PRIORITY_LEVELS.NONE).length;
            document.getElementById('statDuplicates').textContent = allExtractedTasks.filter(t => t.isDuplicate).length;
            document.getElementById('statResponsibles').textContent = new Set(allExtractedTasks.map(t => t.responsible)).size;
        }

        function populateFilterOptions() {
            const createOptions = (values) => '<option value="all">הכל</option>' + [...new Set(values)].filter(v => v && v.trim()).sort().map(v => `<option value="${v}">${v}</option>`).join('');
            document.getElementById('filterResponsible').innerHTML = createOptions(allExtractedTasks.map(t => t.responsible));
            document.getElementById('filterSection').innerHTML = createOptions(allExtractedTasks.map(t => t.section));
            document.getElementById('filterTimeline').innerHTML = createOptions(allExtractedTasks.map(t => t.timeline));
            document.getElementById('filterProtocolDate').innerHTML = createOptions(allExtractedTasks.map(t => t.protocolDate));
        }

        function clearFilters() {
            document.getElementById('filterResponsible').value = 'all';
            document.getElementById('filterSection').value = 'all';
            document.getElementById('filterTimeline').value = 'all';
            document.getElementById('filterProtocolDate').value = 'all';
            document.getElementById('filterPriority').value = 'all';
            applyFilters();
        }

        function toggleSelectAll(tableType) {
            console.log('Toggle select all for:', tableType);
        }

        // --- Task Extraction Functions ---
        function extractTasksFromFileContent(html, fileName) { 
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const textContent = tempDiv.textContent || tempDiv.innerText || "";
                const protocolDate = extractDateFromFileName(fileName) || extractDateFromContent(textContent) || "לא ידוע";
                
                const docType = detectDocumentType(html, textContent);
                
                return (docType === 'staff-meeting') ?
                    extractTasksFromStaffMeeting(html, fileName, protocolDate) :
                    extractTasksFromManagement(tempDiv, textContent, fileName, protocolDate);
                    
            } catch (error) {
                console.error(`Error in extraction from ${fileName}:`, error);
                return [];
            }
        }

        function detectDocumentType(html, textContent) {
            const staffMeetingKeywords = ['ישיבת מטה', 'סיכום והחלטות'];
            const hasStaffKeywords = staffMeetingKeywords.some(kw => textContent.includes(kw));
            return hasStaffKeywords ? 'staff-meeting' : 'management';
        }

        function extractTasksFromManagement(tempDiv, textContent, fileName, protocolDate) {
            let tasks = [];
            const summaryKeyword = 'סיכום/המשך טיפול:';
            
            if (textContent.indexOf(summaryKeyword) === -1) {
                return [];
            }

            const tables = tempDiv.getElementsByTagName('table');
            for (let table of tables) {
                const rows = table.getElementsByTagName('tr');
                if (rows.length < 2) continue;

                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    if (cells.length >= 5) {
                        const task = {
                            numberFromFile: cleanText(cells[0].textContent) || (tasks.length + 1).toString(),
                            section: cleanText(cells[1].textContent) || '',
                            taskDescription: cleanText(cells[2].textContent) || '',
                            responsible: cleanText(cells[3].textContent) || 'לא צוין',
                            timeline: cleanText(cells[4].textContent) || 'לא צוין',
                            documentType: 'סיכום הנהלה',
                            protocolDate: protocolDate,
                            priority: PRIORITY_LEVELS.NONE,
                            isDuplicate: false
                        };
                        if (task.taskDescription.trim()) {
                            tasks.push(task);
                        }
                    }
                }
            }
            return tasks;
        }

        function extractTasksFromStaffMeeting(html, fileName, protocolDate) {
            let tasks = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const tables = tempDiv.getElementsByTagName('table');
            
            for (let table of tables) {
                const rows = table.getElementsByTagName('tr');
                if (rows.length < 2) continue;

                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].children;
                    if (cells.length >= 3) {
                        const task = {
                            numberFromFile: (tasks.length + 1).toString(),
                            section: cleanText(cells[0].textContent) || 'כללי',
                            taskDescription: cleanText(cells[1].textContent) || '',
                            responsible: cleanText(cells[2].textContent) || 'לא צוין',
                            timeline: "לא רלוונטי",
                            documentType: 'ישיבת מטה',
                            protocolDate: protocolDate,
                            priority: PRIORITY_LEVELS.NONE,
                            isDuplicate: false
                        };
                        if (task.taskDescription.trim()) {
                            tasks.push(task);
                        }
                    }
                }
            }
            return tasks;
        }

        function cleanText(text) {
            return (typeof text === 'string') ? text.replace(/\s+/g, ' ').trim() : '';
        }

        function formatDateForDisplay(dateStr) {
            if (!dateStr || dateStr === "לא ידוע") return "לא ידוע";
            return dateStr;
        }

        function extractDateFromFileName(fileName) {
            const datePatterns = [
                /(\d{4}-\d{2}-\d{2})/,
                /(\d{2}-\d{2}-\d{4})/,
                /(\d{2}\.\d{2}\.\d{4})/
            ];
            for (const pattern of datePatterns) {
                const match = fileName.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        function extractDateFromContent(textContent) {
            const contentStart = textContent.substring(0, 500);
            const datePatterns = [
                /\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b/,
                /\b(\d{4}[./-]\d{1,2}[./-]\d{1,2})\b/
            ];
            for (const pattern of datePatterns) {
                const match = contentStart.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        // --- Export/Import Functions ---
        function copyToClipboard() {
            const tasksToExport = getFilteredTasks();
            if (tasksToExport.length === 0) {
                showError("אין משימות להעתקה");
                return;
            }

            let text = `משימות מרוכזות (${tasksToExport.length} משימות)\n\n`;
            
            const managementTasks = tasksToExport.filter(t => t.documentType !== 'ישיבת מטה');
            const staffTasks = tasksToExport.filter(t => t.documentType === 'ישיבת מטה');

            if (managementTasks.length > 0) {
                text += '--- סיכומי ישיבות הנהלה ---\n';
                managementTasks.forEach(task => {
                    text += `${task.globalId}\t${task.section}\t${task.taskDescription}\t${task.responsible}\t${task.timeline}\n`;
                });
            }

            if (staffTasks.length > 0) {
                text += '\n--- סיכומי ישיבות מטה ---\n';
                staffTasks.forEach(task => {
                    text += `${task.globalId}\t${task.section}\t${task.taskDescription}\t${task.responsible}\n`;
                });
            }

            navigator.clipboard.writeText(text).then(() => {
                showSuccess('המשימות הועתקו לזיכרון!');
            }).catch(() => {
                showError('שגיאה בהעתקה');
            });
        }

        function exportToExcel() {
            showError("פונקציית ייצוא CSV זמנית לא זמינה");
        }

        function exportToJSON() {
            showError("פונקציית ייצוא JSON זמנית לא זמינה");
        }

        function importFromJSON() {
            showError("פונקציית ייבוא JSON זמנית לא זמינה");
        }

        function exportSelectedOrAllToICS() {
            showError("פונקציית ייצוא ICS זמנית לא זמינה");
        }

        // --- Main Event Listeners - Must be at the end ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Task Manager initialized successfully');
            
            // Setup for file uploads
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            if (uploadArea && fileInput) {
                uploadArea.addEventListener('click', (e) => {
                    if (e.target.closest('.upload-label')) return;
                    fileInput.click();
                });
                uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
                uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    handleFiles(e.dataTransfer.files);
                });
                fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            }

            // Setup for buttons
            const setupButton = (id, handler) => {
                const btn = document.getElementById(id);
                if (btn) btn.addEventListener('click', handler);
            };

            setupButton('switchToUploadBtn', switchToUploadView);
            setupButton('clearAllBtn', confirmClearAll);
            setupButton('copyClipboardBtn', copyToClipboard);
            setupButton('exportExcelBtn', exportToExcel);
            setupButton('exportJsonBtn', exportToJSON);
            setupButton('importJsonBtn', () => document.getElementById('importFileInput').click());
            setupButton('exportIcsBtn', exportSelectedOrAllToICS);

            const importInput = document.getElementById('importFileInput');
            if (importInput) importInput.addEventListener('change', importFromJSON);

            // Setup for filters
            const setupFilter = (id) => {
                const filter = document.getElementById(id);
                if (filter) filter.addEventListener('change', applyFilters);
            };

            setupFilter('filterResponsible');
            setupFilter('filterSection');
            setupFilter('filterTimeline');
            setupFilter('filterProtocolDate');
            setupFilter('filterPriority');

            const clearBtn = document.getElementById('clearFiltersBtn');
            if (clearBtn) clearBtn.addEventListener('click', clearFilters);

            // Initial load of tasks from the server
            loadTasksFromServer();
        });

        // ========================================================================
        // END OF COMPLETE SCRIPT
        // ========================================================================
    </script>
</body>
</html>