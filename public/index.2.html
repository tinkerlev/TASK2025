<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×œ×™ ×—×™×œ×•×¥ ×•× ×™×”×•×œ ××©×™××•×ª ××¡×™×›×•××™ ×™×©×™×‘×•×ª - ×’×¨×¡×” ××©×•×¤×¨×ª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f7ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-label {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            font-weight: 500;
        }

        .upload-label:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
        }

        .processing {
            padding: 20px;
            text-align: center;
            display: none;
        }
        
        .processing-message {
            margin-top:10px;
            color: #495057;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }

        .results-header h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .filters-section {
            display: none; 
            margin-bottom: 20px; 
            padding: 15px; 
            background: #e9ecef; 
            border-radius: 8px; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            flex-wrap: wrap;
            border: 1px solid #dee2e6;
        }

        .filters-section h4 {
            margin:0 10px 0 0;
            font-size: 1.1em;
            color: #495057;
        }
        
        .filters-section label {
            font-size: 0.95em;
            color: #495057;
            margin-left: 5px;
        }
        
        .filters-section select, .filters-section button {
            padding: 8px 12px; 
            border-radius: 6px; 
            border: 1px solid #ced4da;
            font-size: 0.95em;
        }
        
        .filters-section button {
            background-color: #667eea;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .filters-section button:hover {
            background-color: #5a67d8;
        }
        
        .filters-section button.clear { 
            background-color: #6c757d;
        }
        
        .filters-section button.clear:hover {
            background-color: #5a6268;
        }

        .export-import-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .export-import-section button { 
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }


        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .btn-action {
            padding: 6px 10px;
            font-size: 0.9em;
            margin-left: 4px;
        }
        
        .btn-calendar { background-color: #28a745; color: white; }
        .btn-calendar:hover { background-color: #218838; }
        .btn-ics { background-color: #007bff; color: white; } 
        .btn-ics:hover { background-color: #0056b3; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-delete:hover { background-color: #c82333; }
        .btn-reminder { background-color: #17a2b8; color: white; }
        .btn-reminder:hover { background-color: #138496; }
        .btn-export { background-color: #20c997; color: white; } 
        .btn-export:hover { background-color: #1ba77e; }
        .btn-import { background-color: #fd7e14; color: white; } 
        .btn-import:hover { background-color: #e56b00; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }

        
        .btn-priority { border: 1px solid #ccc; color: #333; background-color: #f8f9fa; }
        .btn-priority.priority-low { background-color: #e6ffed; border-color: #a3e9a4; color: #155724;}
        .btn-priority.priority-medium { background-color: #fff3cd; border-color: #ffeeba; color: #856404;}
        .btn-priority.priority-high { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24;}
        .btn-priority:hover { opacity: 0.8; }

        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .tasks-table:last-child {
            margin-bottom: 0;
        }

        .tasks-table th, .tasks-table td {
            padding: 10px; 
            text-align: right;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        .tasks-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 0.95em; 
        }
        
        .tasks-table td.action-cell {
            text-align: center;
            white-space: nowrap;
        }
        .tasks-table td.selection-cell, .tasks-table th.selection-cell {
            text-align: center;
            vertical-align: middle;
        }

        
        .tasks-table tr.priority-low { background-color: #e6ffed !important; }
        .tasks-table tr.priority-medium { background-color: #fff3cd !important; }
        .tasks-table tr.priority-high { background-color: #f8d7da !important; }
        .tasks-table tr.priority-low:hover { background-color: #d4f8e0 !important; }
        .tasks-table tr.priority-medium:hover { background-color: #ffeeba !important; }
        .tasks-table tr.priority-high:hover { background-color: #f5c6cb !important; }
        .tasks-table tr.duplicate-task { opacity: 0.6; } 

        .tasks-table tr:hover {
            background: #f8f7ff;
        }

        .tasks-table tr:last-child td {
            border-bottom: none;
        }

        .task-number {
            font-weight: bold;
            color: #667eea;
            text-align: center;
        }

        .section-name {
            color: #495057;
            font-weight: 500;
        }
        
        .document-type-label {
            color: #6c757d;
            font-size: 0.85em;
            font-style: italic;
            display: block;
            margin-top: 3px;
        }

        .task-description {
            color: #212529;
            line-height: 1.6;
        }

        .responsible {
            color: #764ba2;
            font-weight: 500;
        }

        .timeline {
            color: #28a745;
            font-weight: 500;
        }
        
        .protocol-date-cell {
            color: #4a5568;
            font-size: 0.9em;
        }

        .no-date {
            color: #dc3545;
            font-style: italic;
        }

        .duplicate-indicator { 
            color: #e53e3e; 
            font-size: 0.8em;
            margin-left: 5px; 
        }


        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 40px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 40px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .file-info {
            background: #e8ebff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-name {
            font-weight: 500;
            color: #667eea;
            margin-bottom: 5px;
        }

        .task-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-card h4 {
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 40px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: none;
        }

        .debug-section h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .debug-content {
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            color: #495057;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .table-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #667eea;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            .header h1 { font-size: 1.8em; }
            .upload-section, .results-section { padding: 20px; }
            .filters-section { flex-direction: column; gap: 10px; align-items: stretch; }
            .filters-section div { display: flex; flex-direction: column; }
            .filters-section label { margin-bottom: 5px; }
            .filters-section select, .filters-section button { width: 100%; }
            .tasks-table { font-size: 0.9em; }
            .tasks-table th, .tasks-table td { padding: 10px; }
            .action-buttons { flex-direction: column; width: 100%; }
            .btn { width: 100%; justify-content: center; }
            .stats-dashboard { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ×›×œ×™ ×—×™×œ×•×¥ ×•× ×™×”×•×œ ××©×™××•×ª ××¡×™×›×•××™ ×™×©×™×‘×•×ª</h1>
            <p>×”×¢×œ×” ×§×•×‘×¥ Word (××• ××¡×¤×¨ ×§×‘×¦×™×) ×œ×—×™×œ×•×¥ ××•×˜×•××˜×™ ×©×œ ×˜×‘×œ×ª ××©×™××•×ª</p>
            <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.8;">×ª×•××š ×‘×¡×™×›×•××™ ×™×©×™×‘×•×ª ×”× ×”×œ×” ×•×™×©×™×‘×•×ª ××˜×”</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“„</div>
                <h3>×’×¨×•×¨ ×§×‘×¦×™× ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</h3>
                <p style="margin-top: 10px; color: #666;">×§×‘×¦×™× × ×ª××›×™×: .docx</p>
                <input type="file" id="fileInput" class="file-input" accept=".docx" multiple>
                <label for="fileInput" class="upload-label">×‘×—×¨ ×§×‘×¦×™×</label>
            </div>
        </div>

        <div class="processing" id="processing">
            <div class="spinner"></div>
            <h3>××¢×‘×“ ×§×‘×¦×™×...</h3>
            <p id="processingMessage" class="processing-message"></p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="debug-section" id="debugSection">
            <h3>××™×“×¢ ×œ××™×ª×•×¨ ×ª×§×œ×•×ª:</h3>
            <div class="debug-content" id="debugContent"></div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>××©×™××•×ª ×©×—×•×œ×¦×•</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="copyToClipboard()">
                        ğŸ“‹ ×”×¢×ª×§ ×œ×–×™×›×¨×•×Ÿ
                    </button>
                    <button class="btn btn-secondary" onclick="switchToUploadView()">
                        ğŸ”„ ×”×•×¡×£ ×§×‘×¦×™× × ×•×¡×¤×™×
                    </button>
                    <button class="btn btn-danger" onclick="confirmClearAllData()">
                        ğŸ—‘ï¸ × ×§×” ×”×›×œ
                    </button>
                </div>
            </div>

            <div class="stats-dashboard" id="statsDashboard">
                <div class="stat-card">
                    <h4>×¡×”"×› ××©×™××•×ª</h4>
                    <div class="value" id="statTotal">0</div>
                </div>
                <div class="stat-card">
                    <h4>××©×™××•×ª ×¢× ×ª×¢×“×•×£</h4>
                    <div class="value" id="statPrioritized">0</div>
                </div>
                <div class="stat-card">
                    <h4>××©×™××•×ª ×›×¤×•×œ×•×ª</h4>
                    <div class="value" id="statDuplicates">0</div>
                </div>
                <div class="stat-card">
                    <h4>××—×¨××™× ×©×•× ×™×</h4>
                    <div class="value" id="statResponsibles">0</div>
                </div>
            </div>

            <div class="export-import-section">
                <button class="btn-export" onclick="exportToExcel()"> 
                    ğŸ“Š ×™×™×¦× ×œ-CSV
                </button>
                <button class="btn-export" onclick="exportToJSON()">
                    ğŸ’¾ ×©××•×¨ ×›-JSON
                </button>
                <button class="btn-import" onclick="document.getElementById('importFileInput').click()">
                    ğŸ“‚ ×˜×¢×Ÿ ××§×•×‘×¥ JSON
                </button>
                <input type="file" id="importFileInput" style="display: none;" accept=".json" onchange="importFromJSON(event)">
                <button class="btn-export btn-ics" onclick="exportSelectedOrAllToICS()">
                    ğŸ“© ×™×™×¦× ×‘×—×™×¨×”/×”×›×œ ×œ-Outlook (ics)
                </button>
            </div>

            <div class="filters-section" id="filtersSection">
                <h4>×¡× ×Ÿ ×ª×¦×•×’×”:</h4>
                <div>
                    <label for="filterResponsible">×œ×¤×™ ××—×¨××™:</label>
                    <select id="filterResponsible" onchange="applyFilters()">
                        <option value="all">×”×›×œ</option>
                    </select>
                </div>
                <div>
                    <label for="filterSection">×œ×¤×™ ×¡×¢×™×£/× ×•×©×:</label>
                    <select id="filterSection" onchange="applyFilters()">
                        <option value="all">×”×›×œ</option>
                    </select>
                </div>
                <div>
                    <label for="filterTimeline">×œ×¤×™ ×œ×•×— ×–×× ×™×:</label>
                    <select id="filterTimeline" onchange="applyFilters()">
                        <option value="all">×”×›×œ</option>
                    </select>
                </div>
                <div>
                    <label for="filterProtocolDate">×œ×¤×™ ×ª××¨×™×š ×¤×¨×•×˜×•×§×•×œ:</label>
                    <select id="filterProtocolDate" onchange="applyFilters()">
                        <option value="all">×”×›×œ</option>
                    </select>
                </div>
                <div>
                    <label for="filterPriority">×œ×¤×™ ×ª×¢×“×•×£:</label>
                    <select id="filterPriority" onchange="applyFilters()">
                        <option value="all">×”×›×œ</option>
                        <option value="3">×’×‘×•×”</option>
                        <option value="2">×‘×™× ×•× ×™</option>
                        <option value="1">× ××•×š</option>
                        <option value="0">×œ×œ×</option>
                    </select>
                </div>
                <button onclick="clearFilters()" class="clear">× ×§×” ×¡×™× ×•× ×™×</button>
            </div>
            
            <div class="file-info" id="fileInfo"></div>

            <div id="divStaffMeetingTasks" style="display:none;">
                <h3 class="table-title">×¡×™×›×•××™ ×™×©×™×‘×•×ª ××˜×”</h3>
                <table class="tasks-table" id="tasksTableStaffMeeting">
                    <thead>
                        <tr>
                            <th style="width: 3%;" class="selection-cell"><input type="checkbox" id="selectAllStaffCheckbox" onchange="toggleSelectAll('staff')"></th>
                            <th style="width: 5%;">××¡' ×›×œ×œ×™</th>
                            <th style="width: 18%;">× ×•×©×</th>
                            <th style="width: 22%;">××©×™××”</th>
                            <th style="width: 12%;">××—×¨××™</th>
                            <th style="width: 10%;">×ª××¨×™×š ×¤×¨×•×˜×•×§×•×œ</th>
                            <th style="width: 20%;">×¤×¢×•×œ×•×ª</th> 
                        </tr>
                    </thead>
                    <tbody id="tasksTableBodyStaffMeeting">
                    </tbody>
                </table>
            </div>

            <div id="divManagementTasks" style="display:none;">
                <h3 class="table-title">×¡×™×›×•××™ ×™×©×™×‘×•×ª ×”× ×”×œ×”</h3>
                <table class="tasks-table" id="tasksTableManagement">
                    <thead>
                        <tr>
                            <th style="width: 3%;" class="selection-cell"><input type="checkbox" id="selectAllManagementCheckbox" onchange="toggleSelectAll('management')"></th>
                            <th style="width: 5%;">××¡' ×›×œ×œ×™</th>
                            <th style="width: 12%;">×¡×¢×™×£</th>
                            <th style="width: 15%;">×”×—×œ×˜×”/×”××©×š ×˜×™×¤×•×œ</th>
                            <th style="width: 10%;">××—×¨××™</th>
                            <th style="width: 10%;">×œ×•×— ×–×× ×™×</th>
                            <th style="width: 10%;">×ª××¨×™×š ×¤×¨×•×˜×•×§×•×œ</th>
                            <th style="width: 25%;">×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTableBodyManagement">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allExtractedTasks = [];
        let lastProcessedFileNames = [];
        let currentFilters = { responsible: 'all', section: 'all', timeline: 'all', protocolDate: 'all', priority: 'all' };
        let nextGlobalTaskId = 1;
        let selectedTaskGlobalIds = new Set();


        const PRIORITY_LEVELS = {
            NONE: 0,
            LOW: 1,
            MEDIUM: 2,
            HIGH: 3
        };
        const PRIORITY_TEXT = {
            [PRIORITY_LEVELS.NONE]: "â­ ×ª×¢×“×£",
            [PRIORITY_LEVELS.LOW]: "â­ × ××•×š",
            [PRIORITY_LEVELS.MEDIUM]: "â­â­ ×‘×™× ×•× ×™",
            [PRIORITY_LEVELS.HIGH]: "â­â­â­ ×’×‘×•×”"
        };
        const PRIORITY_CLASS = {
            [PRIORITY_LEVELS.NONE]: "",
            [PRIORITY_LEVELS.LOW]: "priority-low",
            [PRIORITY_LEVELS.MEDIUM]: "priority-medium",
            [PRIORITY_LEVELS.HIGH]: "priority-high"
        };

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processingMessageElement = document.getElementById('processingMessage');
        
        uploadArea.addEventListener('click', (e) => {
            if (e.target.closest('.upload-label')) {
                return;
            }
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            uploadArea.classList.add('dragover'); 
        });
        
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFiles(files);
        });
        
        fileInput.addEventListener('change', (e) => { 
            if (e.target.files.length > 0) handleFiles(e.target.files); 
        });

        async function handleFiles(files) {
            showProcessing();
            hideMessages();
            document.getElementById('debugSection').style.display = 'none';
            document.getElementById('debugContent').textContent = '';
            
            lastProcessedFileNames = [];
            let validFilesProcessedCount = 0;
            let totalTasksFromBatch = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                processingMessageElement.textContent = `××¢×‘×“ ×§×•×‘×¥ ${i + 1} ××ª×•×š ${files.length}: ${file.name}`;
                
                if (!file.name.endsWith('.docx')) {
                    showError(`×§×•×‘×¥ '${file.name}' ××™× ×• × ×ª××š (× ×“×¨×© .docx). ××“×œ×’.`);
                    showDebug(`Skipped non-docx file: ${file.name}`);
                    continue;
                }
                
                lastProcessedFileNames.push(file.name);
                
                try {
                    const tasksFromFile = await processSingleFileClientSide(file);
                    tasksFromFile.forEach(task => {
                        task.globalId = nextGlobalTaskId++;
                        task.priority = PRIORITY_LEVELS.NONE;
                        task.createdDate = new Date().toISOString(); 
                        allExtractedTasks.push(task);
                    });
                    totalTasksFromBatch += tasksFromFile.length;
                    validFilesProcessedCount++;
                } catch (err) {
                    showError(`×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥ '${file.name}': ${err.message}`);
                    showDebug(`Error processing file ${file.name}: ${err.stack}`);
                }
            }
            
            identifyAndMarkDuplicates();
            saveTasksToLocalStorage(); 
            updateStatistics();

            processingMessageElement.textContent = '';
            hideProcessing();

            if (validFilesProcessedCount > 0) {
                showSuccess(`×¢×™×‘×•×“ ×”×•×©×œ×. ${validFilesProcessedCount} ×§×‘×¦×™× ×¢×•×‘×“×•, × ×•×¡×¤×• ${totalTasksFromBatch} ××©×™××•×ª. ×¡×”"×› ${allExtractedTasks.length} ×‘×¨×©×™××”.`);
            } else if (files.length > 0) {
                showError(`×œ× ×¢×•×‘×“×• ×§×‘×¦×™× ×ª×§×™× ×™× ××ª×•×š ${files.length} ×”×§×‘×¦×™× ×©× ×‘×—×¨×•.`);
            }

            if (allExtractedTasks.length > 0) {
                populateFilterOptions();
                applyFilters();
            } else {
                displayResults([]);
            }
        }

        function generateTaskKey(task) {
            const desc = (task.taskDescription || '').toLowerCase().trim();
            const resp = (task.responsible || '').toLowerCase().trim();
            const time = (task.timeline === "×œ× ×¨×œ×•×•× ×˜×™" ? "×œ× ×¨×œ×•×•× ×˜×™" : (task.timeline || '')).toLowerCase().trim();
            const pDate = task.protocolDate || '×œ× ×™×“×•×¢';
            const docType = task.documentType || '×œ× ×™×“×•×¢';
            return `${desc}|${resp}|${time}|${pDate}|${docType}`;
        }

        function identifyAndMarkDuplicates() {
            const seenTasks = new Set();
            let duplicateCount = 0;
            allExtractedTasks.forEach(task => {
                task.isDuplicate = false;
                const taskKey = generateTaskKey(task);
                if (seenTasks.has(taskKey)) {
                    task.isDuplicate = true;
                    duplicateCount++;
                } else {
                    seenTasks.add(taskKey);
                }
            });
            if (duplicateCount > 0) {
                showDebug(`${duplicateCount} ××©×™××•×ª ×›×¤×•×œ×•×ª ×–×•×”×• ×‘×¡×š ×”×›×œ.`);
            }
            return duplicateCount;
        }
        
        function extractDateFromFileName(fileName) {
            const datePatterns = [
                /(\d{4}-\d{2}-\d{2})/,
                /(\d{2}-\d{2}-\d{4})/,
                /(\d{2}\.\d{2}\.\d{4})/
            ];
            for (const pattern of datePatterns) {
                const match = fileName.match(pattern);
                if (match && match[1]) {
                    let dateStr = match[1];
                    if (pattern.source.includes("DD-MM-YYYY") || pattern.source.includes("DD.MM.YYYY")) {
                        const parts = dateStr.replace(/\./g, '-').split('-');
                        if(parts.length === 3) dateStr = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                    } else if (pattern.source.includes("YYYY-MM-DD")) {
                        const parts = dateStr.split('-');
                        if(parts.length === 3) dateStr = `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
                    }
                    showDebug(`Date extracted from filename '${fileName}' (internal: ${dateStr})`);
                    return dateStr;
                }
            }
            return null;
        }

        function extractDateFromContent(textContent) {
            const contentStart = textContent.substring(0, 500);
            const datePatterns = [
                /\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})\b/,
                /\b(\d{4}[./-]\d{1,2}[./-]\d{1,2})\b/
            ];
            for (const pattern of datePatterns) {
                const match = contentStart.match(pattern);
                if (match && match[1]) {
                    let dateStr = match[1];
                    const parts = dateStr.replace(/[./]/g, '-').split('-');
                    if (parts.length === 3) {
                        let year = '', month = '', day = '';
                        if (parts[2].length === 4) {
                            year = parts[2]; month = parts[1]; day = parts[0];
                        } else if (parts[0].length === 4) {
                            year = parts[0]; month = parts[1]; day = parts[2];
                        } else if (parts[2].length === 2 && parseInt(parts[2]) >= 0 && parseInt(parts[2]) <= 99) {
                            year = `20${parts[2].padStart(2,'0')}`;
                            month = parts[1]; day = parts[0];
                        }
                        if (year && month && day) {
                            const internalDateStr = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                            showDebug(`Date extracted from content (internal: ${internalDateStr})`);
                            return internalDateStr;
                        }
                    }
                }
            }
            return null;
        }

        function formatDateForDisplay(dateStringYYYYMMDD) {
            if (!dateStringYYYYMMDD || dateStringYYYYMMDD === "×œ× ×™×“×•×¢") return "×œ× ×™×“×•×¢";
            const parts = dateStringYYYYMMDD.split('-');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateStringYYYYMMDD;
        }

        function processSingleFileClientSide(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const arrayBuffer = event.target.result;
                    mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                        .then(result => {
                            const htmlContent = result.value;
                            const textContent = new DOMParser().parseFromString(htmlContent, "text/html").body.textContent || "";
                            
                            let protocolDate = extractDateFromFileName(file.name);
                            if (!protocolDate) {
                                protocolDate = extractDateFromContent(textContent);
                            }
                            if (!protocolDate) {
                                protocolDate = "×œ× ×™×“×•×¢";
                                showDebug(`×œ× × ××¦× ×ª××¨×™×š ×¢×‘×•×¨ ×”×§×•×‘×¥: ${file.name}`);
                            }

                            showDebug(`Mammoth output for ${file.name} (first 200 chars): ${htmlContent.substring(0,200)}...`);
                            const tasks = extractTasksFromFileContent(htmlContent, file.name, protocolDate);
                            resolve(tasks);
                        })
                        .catch(err => {
                            reject(new Error(`Mammoth.js ×©×’×™××” ×‘×§×•×‘×¥ ${file.name}: ${err.message}`));
                        });
                };
                reader.onerror = () => {
                    reject(new Error(`×©×’×™××ª FileReader ×‘×§×¨×™××ª ×”×§×•×‘×¥ ${file.name}`));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function detectDocumentType(html, textContent) {
            const staffMeetingKeywords = ['×™×©×™×‘×ª ××˜×”', '×¡×™×›×•× ×•×”×—×œ×˜×•×ª', '×¨×§×¢', '×“×™×•×Ÿ', '×”×—×œ×˜×•×ª'];
            const taskSectionKeywords = ['×¡×˜×˜×•×¡ ××©×™××•×ª', '×¡×™×›×•× ××©×™××•×ª', '××©×™××•×ª ×œ×”××©×š ×˜×™×¤×•×œ'];
            const tableHeaderKeywords = ['× ×•×©×', '××—×¨×™×•×ª', '×’×•×¨× ××‘×¦×¢', '×ª××¨×™×š ×™×¢×“', '×¡×˜×˜×•×¡'];

            let staffMeetingScore = 0;
            staffMeetingKeywords.forEach(kw => {
                if (textContent.includes(kw)) staffMeetingScore++;
            });

            let taskSectionScore = 0;
            taskSectionKeywords.forEach(kw => {
                if (textContent.includes(kw)) taskSectionScore++;
            });
            
            let tableHeaderScore = 0;
            const tempDoc = new DOMParser().parseFromString(html, "text/html");
            const tables = tempDoc.getElementsByTagName('table');
            for(let table of tables){
                const tableText = cleanText(table.textContent);
                let currentTableScore = 0;
                tableHeaderKeywords.forEach(kw => {
                    if(tableText.includes(kw) && kw !== '×ª××¨×™×š ×™×¢×“' && kw !== '×œ×•×— ×–×× ×™×' && kw !== '×œ×•"×–') currentTableScore++;
                });
                if (currentTableScore >= 2) {
                    tableHeaderScore = currentTableScore;
                    break;
                }
            }

            if (staffMeetingScore >= 1 && (tableHeaderScore >= 2 || taskSectionScore >=1) ) {
                showDebug('×–×•×”×” ××¡××š ××¡×•×’: ×™×©×™×‘×ª ××˜×”');
                return 'staff-meeting';
            }
            
            showDebug('×–×•×”×” ××¡××š ××¡×•×’: ×¡×™×›×•× ×”× ×”×œ×”');
            return 'management';
        }

        function extractTasksFromStaffMeeting(html, textContent, fileName, protocolDate) {
            let tasks = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const tables = tempDiv.getElementsByTagName('table');
            
            const columnKeywords = {
                topic: ['× ×•×©×', '×ª×—×•×', '×¨×§×¢'],
                task: ['×”×—×œ×˜×”', '××©×™××”', '×¤×¢×•×œ×” × ×“×¨×©×ª', '×”×¢×¨×•×ª', '×¡×™×›×•×', '×¤×™×¨×•×˜', '×”×—×œ×˜×•×ª ×•×¤×¢×•×œ×•×ª'],
                responsible: ['××—×¨××™', '××—×¨×™×•×ª', '×’×•×¨× ××‘×¦×¢', '×’×•×¨× ××—×¨××™', '×‘××—×¨×™×•×ª']
            };

            showDebug(`××—×¤×© ×˜×‘×œ××•×ª ××©×™××•×ª ×‘×™×©×™×‘×ª ××˜×”: ${fileName}. × ××¦××• ${tables.length} ×˜×‘×œ××•×ª.`);
            
            for (let tableIndex = 0; tableIndex < tables.length; tableIndex++) {
                const table = tables[tableIndex];
                const rows = table.getElementsByTagName('tr');
                if (rows.length < 2) continue;

                const headerRow = rows[0];
                const headerCells = Array.from(headerRow.children).map(cell => cleanText(cell.textContent));
                
                let colMap = {};
                Object.keys(columnKeywords).forEach(key => {
                    columnKeywords[key].forEach(kw => {
                        const index = headerCells.findIndex(hc => hc.includes(kw));
                        if (index !== -1 && colMap[key] === undefined) colMap[key] = index;
                    });
                });
                
                if (colMap.task === undefined || colMap.responsible === undefined || colMap.topic === undefined) {
                    showDebug(`×˜×‘×œ×” ${tableIndex + 1} (××˜×”): ×œ× ×–×•×”×• ×¢××•×“×•×ª '× ×•×©×', '××©×™××”' ×•'××—×¨××™' ×”×›×¨×—×™×•×ª. ××“×œ×’.`);
                    continue;
                }
                showDebug(`×˜×‘×œ×” ${tableIndex + 1} (××˜×”): ×–×•×”×• ×¢××•×“×•×ª: × ×•×©× (${colMap.topic}), ××©×™××” (${colMap.task}), ××—×¨××™ (${colMap.responsible})`);

                let tableTaskCount = 0;
                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].children;
                    const taskDesc = colMap.task < cells.length ? cleanText(cells[colMap.task].textContent) : '';
                    const responsible = colMap.responsible < cells.length ? cleanText(cells[colMap.responsible].textContent) : '×œ× ×¦×•×™×Ÿ';
                    const topic = (colMap.topic < cells.length) ? cleanText(cells[colMap.topic].textContent) : '×›×œ×œ×™';

                    if (taskDesc.trim() === '') continue;

                    tasks.push({
                        numberFromFile: (tasks.length + 1).toString(),
                        section: topic,
                        taskDescription: taskDesc,
                        responsible: responsible,
                        timeline: "×œ× ×¨×œ×•×•× ×˜×™",
                        documentType: '×™×©×™×‘×ª ××˜×”',
                        protocolDate: protocolDate
                    });
                    tableTaskCount++;
                }
                if (tableTaskCount > 0) {
                    showDebug(`×—×•×œ×¦×• ${tableTaskCount} ××©×™××•×ª ××˜×‘×œ×” ${tableIndex + 1} (×™×©×™×‘×ª ××˜×”)`);
                }
            }

            showDebug(`×¡×”"×› ×—×•×œ×¦×• ${tasks.length} ××©×™××•×ª ××™×©×™×‘×ª ××˜×”: ${fileName}`);
            return tasks;
        }

        function extractTasksFromFileContent(html, currentFileNameForDebug = "×œ× ×™×“×•×¢", protocolDate = "×œ× ×™×“×•×¢") {
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const textContent = tempDiv.textContent || tempDiv.innerText || "";
                
                const docType = detectDocumentType(html, textContent);
                showDebug(`×–×•×”×” ×¡×•×’ ××¡××š: ${docType} ×¢×‘×•×¨ ×§×•×‘×¥: ${currentFileNameForDebug}`);
                
                if (docType === 'staff-meeting') {
                    return extractTasksFromStaffMeeting(html, textContent, currentFileNameForDebug, protocolDate);
                }
                
                let tasksForCurrentFile = [];
                const summaryKeyword = '×¡×™×›×•×/×”××©×š ×˜×™×¤×•×œ:';
                if (textContent.indexOf(summaryKeyword) === -1) {
                    showDebug(`×œ× × ××¦××” ×”×›×•×ª×¨×ª "${summaryKeyword}" ×‘×§×•×‘×¥ ×”× ×”×œ×”: ${currentFileNameForDebug}.`);
                    return [];
                }

                const tables = tempDiv.getElementsByTagName('table');
                let tasksTable = null;
                const keywordPositionInHtml = html.lastIndexOf(summaryKeyword);
                for (let i = 0; i < tables.length; i++) {
                    if (html.indexOf(tables[i].outerHTML, keywordPositionInHtml) > keywordPositionInHtml) {
                        const headerKeywords = ['×”×—×œ×˜×”', '××—×¨××™', '×œ×•×— ×–×× ×™×', '××¡\'', '×¡×¢×™×£'];
                        let headerMatchCount = 0;
                        const thCells = tables[i].getElementsByTagName('th');
                        const firstRowCells = (tables[i].rows.length > 0) ? tables[i].rows[0].cells : [];
                        for (let th of thCells) if (headerKeywords.some(kw => cleanText(th.textContent).includes(kw))) headerMatchCount++;
                        if (headerMatchCount < 2 && firstRowCells.length > 0) {
                            for (let cell of firstRowCells) if (headerKeywords.some(kw => cleanText(cell.textContent).includes(kw))) headerMatchCount++;
                        }
                        if (headerMatchCount >= 2) { tasksTable = tables[i]; break; }
                    }
                }

                if (!tasksTable) {
                    showDebug(`×œ× × ××¦××” ×˜×‘×œ×ª ××©×™××•×ª ××ª××™××” ××—×¨×™ "${summaryKeyword}" ×‘×§×•×‘×¥ ×”× ×”×œ×”: ${currentFileNameForDebug}.`);
                    return [];
                }

                const rows = tasksTable.getElementsByTagName('tr');
                let startRow = 0;
                for (let i = 0; i < Math.min(3, rows.length); i++) {
                    if (['××¡\'', '×¡×¢×™×£', '×”×—×œ×˜×”', '××—×¨××™'].some(kw => cleanText(rows[i].textContent).includes(kw))) { startRow = i + 1; break; }
                }
                if (startRow === 0 && rows.length > 0) startRow = 1;

                for (let i = startRow; i < rows.length; i++) {
                    let taskCells = rows[i].getElementsByTagName('td');
                    if (taskCells.length < 5) {
                        const thCells = rows[i].getElementsByTagName('th');
                        if (thCells.length >= 5) taskCells = thCells; else continue;
                    }
                    if (taskCells.length >= 5) {
                        const task = extractTaskFromCells(taskCells, tasksForCurrentFile.length + 1);
                        task.documentType = '×¡×™×›×•× ×”× ×”×œ×”';
                        task.protocolDate = protocolDate;
                        if (task.taskDescription && task.taskDescription.trim() !== '') tasksForCurrentFile.push(task);
                    }
                }
                showDebug(`×—×•×œ×¦×• ${tasksForCurrentFile.length} ××©×™××•×ª ××§×•×‘×¥ ×”× ×”×œ×”: ${currentFileNameForDebug}`);
                return tasksForCurrentFile;

            } catch (error) {
                showDebug(`×©×’×™××” ×‘×—×™×œ×•×¥ ××©×™××•×ª ××§×•×‘×¥ ${currentFileNameForDebug}: ${error.message} - ${error.stack}`);
                return [];
            }
        }
        
        function extractTaskFromCells(cells, taskNumberInFile) {
            const getCellText = (index) => cells[index] ? cleanText(cells[index].textContent) : '';
            return {
                numberFromFile: getCellText(0) || taskNumberInFile.toString(),
                section: getCellText(1) || '',
                taskDescription: getCellText(2) || '',
                responsible: getCellText(3) || '×œ× ×¦×•×™×Ÿ',
                timeline: getCellText(4) || '×œ× ×¦×•×™×Ÿ'
            };
        }
        
        function cleanText(text) {
            return (typeof text === 'string') ? text.replace(/\s+/g, ' ').trim() : '';
        }

        function updateStatistics() {
            document.getElementById('statTotal').textContent = allExtractedTasks.length;
            document.getElementById('statPrioritized').textContent = allExtractedTasks.filter(t => t.priority > PRIORITY_LEVELS.NONE).length;
            document.getElementById('statDuplicates').textContent = allExtractedTasks.filter(t => t.isDuplicate).length;
            document.getElementById('statResponsibles').textContent = new Set(allExtractedTasks.map(t => t.responsible)).size;
        }

        function populateFilterOptions() {
            const responsibleSelect = document.getElementById('filterResponsible');
            const sectionSelect = document.getElementById('filterSection');
            const timelineSelect = document.getElementById('filterTimeline');
            const protocolDateSelect = document.getElementById('filterProtocolDate');

            const populateSelect = (selectElement, valuesSet) => {
                const currentValue = selectElement.value;
                selectElement.innerHTML = '<option value="all">×”×›×œ</option>';
                const mappedValues = (selectElement.id === 'filterProtocolDate') ?
                                     Array.from(valuesSet).map(val => ({value: val, display: formatDateForDisplay(val)})) :
                                     Array.from(valuesSet).map(val => ({value: val, display: val}));
                
                const sortedValues = (selectElement.id === 'filterProtocolDate') ?
                                     mappedValues.sort((a,b) => a.value.localeCompare(b.value)) :
                                     mappedValues;

                sortedValues.forEach(item => {
                    if (item.value && item.value.trim() !== '' && item.value !== "×œ× ×™×“×•×¢" && item.value !== "×œ× ×¨×œ×•×•× ×˜×™") {
                        const option = document.createElement('option');
                        option.value = item.value;
                        option.textContent = item.display;
                        selectElement.appendChild(option);
                    }
                });
                if (Array.from(valuesSet).some(val => val === "×œ× ×™×“×•×¢")) {
                    const unknownOption = document.createElement('option');
                    unknownOption.value = "×œ× ×™×“×•×¢";
                    unknownOption.textContent = "×œ× ×™×“×•×¢";
                    selectElement.appendChild(unknownOption);
                }
                if (selectElement.id === 'filterTimeline' && Array.from(valuesSet).some(val => val === "×œ× ×¨×œ×•×•× ×˜×™")) {
                    const naOption = document.createElement('option');
                    naOption.value = "×œ× ×¨×œ×•×•× ×˜×™";
                    naOption.textContent = "×œ× ×¨×œ×•×•× ×˜×™";
                    selectElement.appendChild(naOption);
                }
                selectElement.value = Array.from(selectElement.options).some(opt => opt.value === currentValue) ? currentValue : 'all';
            };

            populateSelect(responsibleSelect, new Set(allExtractedTasks.map(task => task.responsible)));
            populateSelect(sectionSelect, new Set(allExtractedTasks.map(task => task.section)));
            populateSelect(timelineSelect, new Set(allExtractedTasks.map(task => task.timeline)));
            populateSelect(protocolDateSelect, new Set(allExtractedTasks.map(task => task.protocolDate)));
        }
        
        function getFilteredTasks() {
            return allExtractedTasks.filter(task =>
                (currentFilters.responsible === 'all' || task.responsible === currentFilters.responsible) &&
                (currentFilters.section === 'all' || task.section === currentFilters.section) &&
                (currentFilters.timeline === 'all' || task.timeline === currentFilters.timeline) &&
                (currentFilters.protocolDate === 'all' || task.protocolDate === currentFilters.protocolDate) &&
                (currentFilters.priority === 'all' || task.priority === parseInt(currentFilters.priority))
            );
        }

        function applyFilters() {
            currentFilters.responsible = document.getElementById('filterResponsible').value;
            currentFilters.section = document.getElementById('filterSection').value;
            currentFilters.timeline = document.getElementById('filterTimeline').value;
            currentFilters.protocolDate = document.getElementById('filterProtocolDate').value;
            currentFilters.priority = document.getElementById('filterPriority').value;
            displayResults(getFilteredTasks());
            updateStatistics(); 
        }
        
        function confirmClearAllData() {
            if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×›×œ ×”××©×™××•×ª ×•×”× ×ª×•× ×™×? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.")) {
                clearAllData();
                showSuccess("×›×œ ×”× ×ª×•× ×™× × ×•×§×• ×‘×”×¦×œ×—×”.");
            }
        }

        function clearAllData() {
            allExtractedTasks = [];
            lastProcessedFileNames = [];
            currentFilters = { responsible: 'all', section: 'all', timeline: 'all', protocolDate: 'all', priority: 'all' };
            nextGlobalTaskId = 1;
            selectedTaskGlobalIds.clear(); 

            document.getElementById('tasksTableBodyStaffMeeting').innerHTML = '';
            document.getElementById('tasksTableBodyManagement').innerHTML = '';
            document.getElementById('divStaffMeetingTasks').style.display = 'none';
            document.getElementById('divManagementTasks').style.display = 'none';

            const selectAllStaff = document.getElementById('selectAllStaffCheckbox');
            if (selectAllStaff) selectAllStaff.checked = false;
            const selectAllManagement = document.getElementById('selectAllManagementCheckbox');
            if (selectAllManagement) selectAllManagement.checked = false;


            document.getElementById('filterResponsible').innerHTML = '<option value="all">×”×›×œ</option>';
            document.getElementById('filterSection').innerHTML = '<option value="all">×”×›×œ</option>';
            document.getElementById('filterTimeline').innerHTML = '<option value="all">×”×›×œ</option>';
            document.getElementById('filterProtocolDate').innerHTML = '<option value="all">×”×›×œ</option>';
            document.getElementById('filterPriority').value = 'all';


            updateStatistics(); 

            document.getElementById('fileInfo').innerHTML = '';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('filtersSection').style.display = 'none';
            
            hideMessages(); 
            document.getElementById('debugSection').style.display = 'none';
            document.getElementById('debugContent').textContent = '';
            if (fileInput) fileInput.value = ''; 

            localStorage.removeItem('savedTasks');
            localStorage.removeItem('nextGlobalTaskId');
            localStorage.removeItem('lastProcessedFileNames');
            localStorage.removeItem('selectedTaskGlobalIds');


            console.log("All data cleared including localStorage");
        }


        function deleteTask(globalId) {
            const taskIndex = allExtractedTasks.findIndex(task => task.globalId === globalId);
            if (taskIndex > -1) {
                allExtractedTasks.splice(taskIndex, 1);
                selectedTaskGlobalIds.delete(globalId); 
                showSuccess("×”××©×™××” × ××—×§×”.");
                identifyAndMarkDuplicates();
                saveTasksToLocalStorage();
                updateStatistics();
                populateFilterOptions();
                applyFilters();
            } else {
                showError("×©×’×™××”: ×”××©×™××” ×œ××—×™×§×” ×œ× × ××¦××”.");
            }
        }

        function togglePriority(globalId) {
            const task = allExtractedTasks.find(task => task.globalId === globalId);
            if (task) {
                task.priority = (task.priority + 1) % (Object.keys(PRIORITY_LEVELS).length);
                saveTasksToLocalStorage();
                updateStatistics();
                applyFilters();
            }
        }

        function setTaskReminder(globalId) {
            const task = allExtractedTasks.find(t => t.globalId === globalId);
            if (!task) {
                showError("××©×™××” ×œ× × ××¦××”.");
                return;
            }

            const dateStr = prompt("×”×›× ×¡ ×ª××¨×™×š ×œ×ª×–×›×•×¨×ª (YYYY-MM-DD):");
            if (!dateStr) return;

            const timeStr = prompt("×”×›× ×¡ ×©×¢×” ×œ×ª×–×›×•×¨×ª (HH:MM, ×œ×“×•×’××” 14:30):");
            if (!timeStr) return;

            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            const timeRegex = /^\d{2}:\d{2}$/;

            if (!dateRegex.test(dateStr) || !timeRegex.test(timeStr)) {
                showError("×¤×•×¨××˜ ×”×ª××¨×™×š ××• ×”×©×¢×” ××™× ×• ×ª×§×™×Ÿ. ×× × ×”×©×ª××© ×‘-YYYY-MM-DD ×•×‘-HH:MM.");
                return;
            }

            const reminderDateTime = new Date(`${dateStr}T${timeStr}:00`);
            if (isNaN(reminderDateTime.getTime())) {
                showError("×”×ª××¨×™×š ××• ×”×©×¢×” ×©×”×•×–× ×• ××™× × ×—×•×§×™×™×.");
                return;
            }

            const delay = reminderDateTime.getTime() - new Date().getTime();
            if (delay < 0) {
                showError("×œ× × ×™×ª×Ÿ ×œ×”×’×“×™×¨ ×ª×–×›×•×¨×ª ×œ×–××Ÿ ×©×›×‘×¨ ×¢×‘×¨.");
                return;
            }

            const doSchedule = () => {
                setTimeout(() => {
                    new Notification("×ª×–×›×•×¨×ª ×œ××©×™××”:", {
                        body: task.taskDescription,
                        icon: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGnSURBVFhHxZftSsRAEER/e+nBSBUSRBAlEqELFReRBPEBfMWDEy9eRBSCBL2LQKyLgBCJIN7AlRAl4g+gqN4L/g0j2Wl2Z3cyu7MDBwNzdt/szs7O7GwhwnsY4cF30P9dENAmgK8J1O1s34gP4bMHYLgLll9pRvY7y3ZgGI4lcVwKq2YgL7Y6K4VfV5gHvgFv6X90z5VgitgsQ4y3TVrdxtjplmF76V0h0kGAV8P3gZgCPE7kESIC3lQnQNQ1DpvE/ZSLwnMM474Az0LzAEUADgPhZKB1kPOY2jRkRLv0NZAn9k5PISmAJoDTEBFx2x8yqkSNHgKqQ0sAEmAxAHSk7z1AmgEmAFQApQCvAKMA8wK7C9g3P2QxgG8yHHCyAFkBCkBCYAmgHMAFQCMQCcAlQCvAKMAPQC/AVL8M2j50pQApAA6A0gAtAKUARgArALUApQClACYALgCXAEsAUwA5gA5ADiABkAC4ARwAFgAqAFrAAlAC2AFMAGYAMwAZgAiACIARYBGgAqAK0AdYBaAPWAHUAfgCfAGeASgBdARsB8gQYg8c928A0gBHYL7AfoD+BfMPlX5sN+KxXAAAAAElFTkSuQmCC"
                    });
                }, delay);
                showSuccess(`×ª×–×›×•×¨×ª × ×§×‘×¢×” ×¢×‘×•×¨: "${task.taskDescription.substring(0,30)}..." ×œ-${formatDateForDisplay(dateStr)} ${timeStr}.`);
            };
            
            if (Notification.permission === "granted") {
                doSchedule();
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        doSchedule();
                    } else {
                        showError("×”×”×¨×©××” ×œ×”×¦×™×’ ×”×ª×¨××•×ª × ×“×—×ª×”. ×œ× × ×™×ª×Ÿ ×œ×”×’×“×™×¨ ×ª×–×›×•×¨×ª.");
                    }
                });
            } else {
                showError("×”×”×¨×©××” ×œ×”×¦×™×’ ×”×ª×¨××•×ª ×—×¡×•××”. ×‘×“×•×§ ××ª ×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ.");
            }
        }

        function toggleTaskSelection(globalId, isChecked) {
            if (isChecked) {
                selectedTaskGlobalIds.add(globalId);
            } else {
                selectedTaskGlobalIds.delete(globalId);
            }
            showDebug(`Selected tasks: ${selectedTaskGlobalIds.size}`);
            updateSelectAllCheckboxesState();
        }

        function toggleSelectAll(tableType) {
            const isChecked = (tableType === 'staff') ? 
                              document.getElementById('selectAllStaffCheckbox').checked : 
                              document.getElementById('selectAllManagementCheckbox').checked;
            
            const tasksInTable = (tableType === 'staff') ? 
                                 getFilteredTasks().filter(t => t.documentType === '×™×©×™×‘×ª ××˜×”') :
                                 getFilteredTasks().filter(t => t.documentType === '×¡×™×›×•× ×”× ×”×œ×”');

            tasksInTable.forEach(task => {
                const checkbox = document.querySelector(`.task-checkbox[value="${task.globalId}"]`);
                if (checkbox) checkbox.checked = isChecked;
                if (isChecked) {
                    selectedTaskGlobalIds.add(task.globalId);
                } else {
                    selectedTaskGlobalIds.delete(task.globalId);
                }
            });
            showDebug(`Selected tasks after 'Select All' (${tableType}): ${selectedTaskGlobalIds.size}`);
        }
        
        function updateSelectAllCheckboxesState() {
            const staffTasksInView = getFilteredTasks().filter(t => t.documentType === '×™×©×™×‘×ª ××˜×”');
            const managementTasksInView = getFilteredTasks().filter(t => t.documentType === '×¡×™×›×•× ×”× ×”×œ×”');

            const allStaffVisibleSelected = staffTasksInView.length > 0 && staffTasksInView.every(t => selectedTaskGlobalIds.has(t.globalId));
            const allManagementVisibleSelected = managementTasksInView.length > 0 && managementTasksInView.every(t => selectedTaskGlobalIds.has(t.globalId));

            const selectAllStaffCheckbox = document.getElementById('selectAllStaffCheckbox');
            if (selectAllStaffCheckbox) selectAllStaffCheckbox.checked = allStaffVisibleSelected;
            
            const selectAllManagementCheckbox = document.getElementById('selectAllManagementCheckbox');
            if (selectAllManagementCheckbox) selectAllManagementCheckbox.checked = allManagementVisibleSelected;
        }


        function displayResults(tasksToDisplay = allExtractedTasks) {
            const resultsSection = document.getElementById('resultsSection');
            const fileInfo = document.getElementById('fileInfo');
            const filtersSection = document.getElementById('filtersSection');

            const divStaffMeetingTasks = document.getElementById('divStaffMeetingTasks');
            const tasksTableBodyStaffMeeting = document.getElementById('tasksTableBodyStaffMeeting');
            const divManagementTasks = document.getElementById('divManagementTasks');
            const tasksTableBodyManagement = document.getElementById('tasksTableBodyManagement');

            tasksTableBodyStaffMeeting.innerHTML = '';
            tasksTableBodyManagement.innerHTML = '';
            
            const staffMeetingTasks = tasksToDisplay.filter(task => task.documentType === '×™×©×™×‘×ª ××˜×”');
            const managementTasks = tasksToDisplay.filter(task => task.documentType === '×¡×™×›×•× ×”× ×”×œ×”');

            let fileInfoText;
            if (lastProcessedFileNames.length === 1) {
                fileInfoText = `×§×‘×¦×™× ×©×¢×•×‘×“×•: ${lastProcessedFileNames[0]}. `;
            } else if (lastProcessedFileNames.length > 1) {
                fileInfoText = `×§×‘×¦×™× ×©×¢×•×‘×“×• (${lastProcessedFileNames.length}): ${lastProcessedFileNames.join(', ').substring(0,100)}... `;
            } else if (allExtractedTasks.length > 0) {
                fileInfoText = `××©×™××•×ª × ×˜×¢× ×•. `;
            } else {
                fileInfoText = `×œ× × ×‘×—×¨×• ×§×‘×¦×™×. `;
            }
            
            let totalDuplicatesOverall = allExtractedTasks.filter(t => t.isDuplicate).length;

            let countText;
            if (tasksToDisplay.length === allExtractedTasks.length && 
                currentFilters.responsible === 'all' && 
                currentFilters.section === 'all' && 
                currentFilters.timeline === 'all' &&
                currentFilters.protocolDate === 'all' &&
                currentFilters.priority === 'all') {
                countText = `×¡×”"×› ${allExtractedTasks.length} ××©×™××•×ª.`;
            } else {
                countText = `××¦×™×’ ${tasksToDisplay.length} ××ª×•×š ${allExtractedTasks.length} ××©×™××•×ª (${staffMeetingTasks.length} ××˜×”, ${managementTasks.length} ×”× ×”×œ×”).`;
            }
            if (totalDuplicatesOverall > 0) {
                countText += ` ×–×•×”×• ${totalDuplicatesOverall} ×›×¤×™×œ×•×™×•×ª ×‘×¡×š ×”×›×œ.`;
            }
            
            fileInfo.innerHTML = `
                <span class="file-name">${fileInfoText}</span>
                <span class="task-count">${countText}</span>`;
            
            if (staffMeetingTasks.length > 0) {
                divStaffMeetingTasks.style.display = 'block';
                staffMeetingTasks.forEach((task) => {
                    const row = tasksTableBodyStaffMeeting.insertRow();
                    row.className = PRIORITY_CLASS[task.priority] || '';
                    
                    row.innerHTML = `
                        <td class="selection-cell"><input type="checkbox" class="task-checkbox" value="${task.globalId}" onchange="toggleTaskSelection(${task.globalId}, this.checked)" ${selectedTaskGlobalIds.has(task.globalId) ? 'checked' : ''}></td>
                        <td class="task-number">${task.globalId}</td>
                        <td class="section-name">
                            ${task.section || ''}
                        </td>
                        <td class="task-description">${task.taskDescription || ''}</td>
                        <td class="responsible">${task.responsible || '×œ× ×¦×•×™×Ÿ'}</td>
                        <td class="protocol-date-cell">${formatDateForDisplay(task.protocolDate)}</td>
                        <td class="action-cell">
                            <button class="btn-action btn-reminder" onclick="setTaskReminder(${task.globalId})" title="×”×’×“×¨ ×ª×–×›×•×¨×ª">â°</button>
                            <button class="btn-action btn-calendar" onclick="addTaskToCalendar(${task.globalId})" title="×”×•×¡×£ ×œ×™×•××Ÿ Google">ğŸ“…</button>
                            <button class="btn-action btn-ics" onclick="exportSingleTaskToICS(${task.globalId})" title="×™×™×¦× ×œ-Outlook (ics)">ğŸ“©</button>
                            <button class="btn-action btn-priority ${PRIORITY_CLASS[task.priority] || ''}" onclick="togglePriority(${task.globalId})" title="×©× ×” ×ª×¢×“×•×£">${PRIORITY_TEXT[task.priority]}</button>
                            <button class="btn-action btn-delete" onclick="deleteTask(${task.globalId})" title="××—×§ ××©×™××”">ğŸ—‘ï¸</button>
                        </td>
                    `;
                });
            } else {
                divStaffMeetingTasks.style.display = 'none';
            }

            if (managementTasks.length > 0) {
                divManagementTasks.style.display = 'block';
                managementTasks.forEach((task) => {
                    const row = tasksTableBodyManagement.insertRow();
                    row.className = PRIORITY_CLASS[task.priority] || '';
                    const timelineClass = (task.timeline === '×œ× ×¦×•×™×Ÿ' || task.timeline === '' || task.timeline === '×œ× ×¨×œ×•×•× ×˜×™') ? 'no-date' : 'timeline';
                    row.innerHTML = `
                        <td class="selection-cell"><input type="checkbox" class="task-checkbox" value="${task.globalId}" onchange="toggleTaskSelection(${task.globalId}, this.checked)" ${selectedTaskGlobalIds.has(task.globalId) ? 'checked' : ''}></td>
                        <td class="task-number">${task.globalId}</td>
                        <td class="section-name">
                            ${task.section || ''}
                        </td>
                        <td class="task-description">${task.taskDescription || ''}</td>
                        <td class="responsible">${task.responsible || '×œ× ×¦×•×™×Ÿ'}</td>
                        <td class="${timelineClass}">${task.timeline || '×œ× ×¦×•×™×Ÿ'}</td>
                        <td class="protocol-date-cell">${formatDateForDisplay(task.protocolDate)}</td>
                        <td class="action-cell">
                            <button class="btn-action btn-reminder" onclick="setTaskReminder(${task.globalId})" title="×”×’×“×¨ ×ª×–×›×•×¨×ª">â°</button>
                            <button class="btn-action btn-calendar" onclick="addTaskToCalendar(${task.globalId})" title="×”×•×¡×£ ×œ×™×•××Ÿ Google">ğŸ“…</button>
                            <button class="btn-action btn-ics" onclick="exportSingleTaskToICS(${task.globalId})" title="×™×™×¦× ×œ-Outlook (ics)">ğŸ“©</button>
                            <button class="btn-action btn-priority ${PRIORITY_CLASS[task.priority] || ''}" onclick="togglePriority(${task.globalId})" title="×©× ×” ×ª×¢×“×•×£">${PRIORITY_TEXT[task.priority]}</button>
                            <button class="btn-action btn-delete" onclick="deleteTask(${task.globalId})" title="××—×§ ××©×™××”">ğŸ—‘ï¸</button>
                        </td>
                    `;
                });
            } else {
                divManagementTasks.style.display = 'none';
            }
            
            updateSelectAllCheckboxesState(); 
            resultsSection.style.display = 'block';
            filtersSection.style.display = allExtractedTasks.length > 0 ? 'flex' : 'none';
            document.getElementById('uploadSection').style.display = 'none';
        }

        function parseTaskDateForCalendar(dateStringYYYYMMDD) {
            if (!dateStringYYYYMMDD || dateStringYYYYMMDD === "×œ× ×™×“×•×¢" || dateStringYYYYMMDD === "×œ× ×¨×œ×•×•× ×˜×™") return null;
            const parts = dateStringYYYYMMDD.split('-');
            if (parts.length === 3) {
                return { year: parseInt(parts[0]), month: parseInt(parts[1]), day: parseInt(parts[2]) };
            }
            showDebug(`Could not parse YYYY-MM-DD date for calendar: ${dateStringYYYYMMDD}`);
            return null;
        }

        function formatDateForGoogleCalendar(dateObj) {
            if (!dateObj) return '';
            const year = dateObj.year;
            const month = String(dateObj.month).padStart(2, '0');
            const day = String(dateObj.day).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function formatDateForICS(dateObj) { 
            if (!dateObj) return '';
            return `${dateObj.year}${String(dateObj.month).padStart(2, '0')}${String(dateObj.day).padStart(2, '0')}`;
        }
        
        function formatDateTimeForICS(date) { 
            return date.getUTCFullYear() +
                String(date.getUTCMonth() + 1).padStart(2, '0') +
                String(date.getUTCDate()).padStart(2, '0') +
                'T' +
                String(date.getUTCHours()).padStart(2, '0') +
                String(date.getUTCMinutes()).padStart(2, '0') +
                String(date.getUTCSeconds()).padStart(2, '0') +
                'Z';
        }

        function generateICSContent(tasks) {
            const now = new Date();
            const dtstamp = formatDateTimeForICS(now);
            let icsEvents = [];

            tasks.forEach(task => {
                let startDateObj = null;
                if (task.documentType === '×™×©×™×‘×ª ××˜×”') {
                    if (task.protocolDate && task.protocolDate !== "×œ× ×™×“×•×¢") {
                        startDateObj = parseTaskDateForCalendar(task.protocolDate);
                    }
                } else {
                    const timelineLower = (task.timeline || '').toLowerCase();
                    const dateRegex = /(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/;
                    if (timelineLower !== '×œ× ×¦×•×™×Ÿ' && timelineLower.trim() !== '' && timelineLower !== '×œ× ×¨×œ×•×•× ×˜×™') {
                        const match = timelineLower.match(dateRegex);
                        if (match && match[1]) {
                            let parts = match[1].replace(/[./]/g, '-').split('-');
                            if (parts.length === 3) {
                                let year = parts[2], month = parts[1], day = parts[0];
                                if (parts[0].length === 4) { year = parts[0]; month = parts[1]; day = parts[2]; }
                                else if (parts[2].length === 2) { year = `20${parts[2]}`; }
                                startDateObj = parseTaskDateForCalendar(`${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`);
                            }
                        }
                    }
                    if (!startDateObj && task.protocolDate && task.protocolDate !== "×œ× ×™×“×•×¢") {
                        startDateObj = parseTaskDateForCalendar(task.protocolDate);
                    }
                }

                if (startDateObj) {
                    const dtstart = formatDateForICS(startDateObj);
                    let endDateForICS = new Date(startDateObj.year, startDateObj.month - 1, startDateObj.day);
                    endDateForICS.setDate(endDateForICS.getDate() + 1);
                    const dtend = formatDateForICS({year: endDateForICS.getFullYear(), month: endDateForICS.getMonth() + 1, day: endDateForICS.getDate()});
                    const uid = `task-${task.globalId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}@taskextractor.com`;

                    const eventContent = [
                        "BEGIN:VEVENT",
                        `UID:${uid}`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART;VALUE=DATE:${dtstart}`,
                        `DTEND;VALUE=DATE:${dtend}`,
                        `SUMMARY:${task.taskDescription.replace(/(\r\n|\n|\r)/gm, "\\n")}`,
                        `DESCRIPTION:××—×¨××™: ${task.responsible || '×œ× ×¦×•×™×Ÿ'}\\n×¡×¢×™×£/× ×•×©×: ${task.section || '×œ× ×¦×•×™×Ÿ'}\\n` +
                        (task.documentType !== '×™×©×™×‘×ª ××˜×”' ? `×œ×•×— ×–×× ×™× ××§×•×¨×™: ${task.timeline || '×œ× ×¦×•×™×Ÿ'}\\n` : '') +
                        `×ª××¨×™×š ×¤×¨×•×˜×•×§×•×œ: ${formatDateForDisplay(task.protocolDate)}\\n×¡×•×’ ××¡××š: ${task.documentType || '×œ× ×™×“×•×¢'}`,
                        `X-MICROSOFT-CDO-BUSYSTATUS:FREE`,
                        `X-MICROSOFT-CDO-ALLDAYEVENT:TRUE`,
                        "END:VEVENT"
                    ].join("\r\n");
                    icsEvents.push(eventContent);
                } else {
                    showDebug(`Skipping task ${task.globalId} for ICS export due to missing date.`);
                }
            });

            if (icsEvents.length === 0) return null;

            return [
                "BEGIN:VCALENDAR",
                "VERSION:2.0",
                "PRODID:-//TaskExtractor//NONSGML v1.0//EN",
                ...icsEvents,
                "END:VCALENDAR"
            ].join("\r\n");
        }

        function exportSingleTaskToICS(globalId) {
            const task = allExtractedTasks.find(t => t.globalId === globalId);
            if (!task) {
                showError("××©×™××” ×œ× × ××¦××” ×œ×™×™×¦×•× ×œ-ICS.");
                return;
            }
            const icsContent = generateICSContent([task]);
            if (icsContent) {
                downloadICSFile(icsContent, `××©×™××”_${task.globalId}.ics`);
                showSuccess(`×§×•×‘×¥ ICS × ×•×¦×¨ ×¢×‘×•×¨ ××©×™××”: ${task.globalId}`);
            } else {
                showError(`×œ× × ×™×ª×Ÿ ×”×™×” ×œ×™×¦×•×¨ ×§×•×‘×¥ ICS ×¢×‘×•×¨ ××©×™××” ${task.globalId} (×™×™×ª×›×Ÿ ×©×—×¡×¨ ×ª××¨×™×š).`);
            }
        }
        
        function exportSelectedOrAllToICS() {
            showDebug("exportSelectedOrAllToICS function called.");
            let tasksToExport;
            if (selectedTaskGlobalIds.size > 0) {
                tasksToExport = allExtractedTasks.filter(task => selectedTaskGlobalIds.has(task.globalId));
                showDebug(`Exporting ${selectedTaskGlobalIds.size} selected tasks to ICS.`);
            } else {
                tasksToExport = getFilteredTasks();
                if (tasksToExport.length === 0) {
                    showError("××™×Ÿ ××©×™××•×ª ×œ×™×™×¦×•× (×œ× × ×‘×—×¨×• ××©×™××•×ª ×•×œ× ××•×¦×’×•×ª ××©×™××•×ª ××¡×•× × ×•×ª).");
                    return;
                }
                showDebug(`No tasks selected, exporting ${tasksToExport.length} currently displayed/filtered tasks to ICS.`);
            }

            const icsContent = generateICSContent(tasksToExport);
            if (icsContent) {
                downloadICSFile(icsContent, `××©×™××•×ª_Outlook_${new Date().toISOString().split('T')[0]}.ics`);
                showSuccess(`${tasksToExport.length} ××©×™××•×ª ×™×•×¦××• ×œ×§×•×‘×¥ ICS.`);
            } else {
                 showError("×œ× × ×•×¦×¨ ×§×•×‘×¥ ICS (×™×™×ª×›×Ÿ ×©×œ× × ××¦××• ×ª××¨×™×›×™× ×ª×§×™× ×™× ×‘××©×™××•×ª ×©× ×‘×—×¨×•).");
            }
        }

        function downloadICSFile(icsContent, fileName) {
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }


        function addTaskToCalendar(globalId) { // For Google Calendar
            const task = allExtractedTasks.find(t => t.globalId === globalId);
            if (!task) {
                showError("××©×™××” ×œ× × ××¦××”.");
                return;
            }

            let startDateObj = null;
            
            if (task.documentType === '×™×©×™×‘×ª ××˜×”') {
                if (task.protocolDate && task.protocolDate !== "×œ× ×™×“×•×¢") {
                    startDateObj = parseTaskDateForCalendar(task.protocolDate);
                }
            } else {
                const timelineLower = (task.timeline || '').toLowerCase();
                const dateRegex = /(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/;
                
                if (timelineLower !== '×œ× ×¦×•×™×Ÿ' && timelineLower.trim() !== '' && timelineLower !== '×œ× ×¨×œ×•×•× ×˜×™') {
                    const match = timelineLower.match(dateRegex);
                    if (match && match[1]) {
                        let parts = match[1].replace(/[./]/g, '-').split('-');
                        if (parts.length === 3) {
                            let year = parts[2], month = parts[1], day = parts[0];
                            if (parts[0].length === 4) {
                                year = parts[0]; month = parts[1]; day = parts[2];
                            } else if (parts[2].length === 2) {
                                year = `20${parts[2]}`;
                            }
                            startDateObj = parseTaskDateForCalendar(`${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`);
                        }
                    } else if (timelineLower.startsWith('×¢×“ ')) {
                        const datePart = timelineLower.substring(3).trim();
                        const untilMatch = datePart.match(dateRegex);
                        if (untilMatch && untilMatch[1]) {
                            let parts = untilMatch[1].replace(/[./]/g, '-').split('-');
                            if (parts.length === 3) {
                                let year = parts[2], month = parts[1], day = parts[0];
                                if (parts[0].length === 4) {year = parts[0]; month = parts[1]; day = parts[2];}
                                else if (parts[2].length === 2) {year = `20${parts[2]}`;}
                                startDateObj = parseTaskDateForCalendar(`${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`);
                            }
                        }
                    }
                }
                if (!startDateObj && task.protocolDate && task.protocolDate !== "×œ× ×™×“×•×¢") {
                    startDateObj = parseTaskDateForCalendar(task.protocolDate);
                }
            }

            if (!startDateObj) {
                showError(`×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×ª××¨×™×š ×¢×‘×•×¨ ××©×™××” ×–×• ("${task.taskDescription.substring(0,20)}...") ×œ×™×•××Ÿ.`);
                return;
            }

            let endDateObj = new Date(startDateObj.year, startDateObj.month - 1, startDateObj.day);
            endDateObj.setDate(endDateObj.getDate() + 1);
            const endDateGoogle = formatDateForGoogleCalendar({year: endDateObj.getFullYear(), month: endDateObj.getMonth() + 1, day: endDateObj.getDate()});
            const startDateGoogle = formatDateForGoogleCalendar(startDateObj);

            const eventTitle = encodeURIComponent(task.taskDescription);
            const eventDetails = encodeURIComponent(
                `××—×¨××™: ${task.responsible || '×œ× ×¦×•×™×Ÿ'}\n` +
                `×¡×¢×™×£/× ×•×©×: ${task.section || '×œ× ×¦×•×™×Ÿ'}\n` +
                (task.documentType !== '×™×©×™×‘×ª ××˜×”' ? `×œ×•×— ×–×× ×™× ××§×•×¨×™: ${task.timeline || '×œ× ×¦×•×™×Ÿ'}\n` : '') +
                `×ª××¨×™×š ×¤×¨×•×˜×•×§×•×œ: ${formatDateForDisplay(task.protocolDate)}\n` +
                `×¡×•×’ ××¡××š: ${task.documentType || '×œ× ×™×“×•×¢'}`
            );

            const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${eventTitle}&dates=${startDateGoogle}/${endDateGoogle}&details=${eventDetails}`;
            
            showDebug(`Google Calendar URL: ${googleCalendarUrl}`);
            window.open(googleCalendarUrl, '_blank');
        }

        function copyToClipboard() {
            showDebug("copyToClipboard function called.");
            let tasksToCopy;
            if (selectedTaskGlobalIds.size > 0) {
                tasksToCopy = allExtractedTasks.filter(task => selectedTaskGlobalIds.has(task.globalId));
                showDebug(`Copying ${selectedTaskGlobalIds.size} selected tasks.`);
            } else {
                tasksToCopy = getFilteredTasks();
                if (tasksToCopy.length === 0) {
                    showError("××™×Ÿ ××©×™××•×ª ×œ×”×¢×ª×§×” (×œ× × ×‘×—×¨×• ××©×™××•×ª ×•×œ× ××•×¦×’×•×ª ××©×™××•×ª ××¡×•× × ×•×ª).");
                    return;
                }
                showDebug(`No tasks selected, copying ${tasksToCopy.length} currently displayed/filtered tasks.`);
            }
            
            const staffMeetingTasks = tasksToCopy.filter(task => task.documentType === '×™×©×™×‘×ª ××˜×”');
            const managementTasks = tasksToCopy.filter(task => task.documentType === '×¡×™×›×•× ×”× ×”×œ×”');

            let text = `××©×™××•×ª ××¨×•×›×–×•×ª (×¡×”"×› ${tasksToCopy.length} ××©×™××•×ª ×”×•×¢×ª×§×•)\n`;
            if (lastProcessedFileNames.length > 0 && selectedTaskGlobalIds.size === 0) { 
                text += `(××ª×•×š ×§×‘×¦×™×: ${lastProcessedFileNames.join(', ')})\n`;
            }
            let totalDuplicatesInSelection = tasksToCopy.filter(t => t.isDuplicate).length;
            if (totalDuplicatesInSelection > 0) {
                text += `(××ª×•×›×Ÿ ${totalDuplicatesInSelection} ××©×™××•×ª ×›×¤×•×œ×•×ª)\n`;
            }


            const getPriorityTextForCopy = (priorityLevel) => {
                const priorityKeys = ['×œ×œ×', '× ××•×š', '×‘×™× ×•× ×™', '×’×‘×•×”']; 
                return priorityKeys[priorityLevel] || '×œ×œ×';
            }

            if (staffMeetingTasks.length > 0) {
                text += '\n--- ×¡×™×›×•××™ ×™×©×™×‘×•×ª ××˜×” ---\n';
                text += '××¡\' ×›×œ×œ×™\t× ×•×©×\t××©×™××”\t××—×¨××™\t×ª××¨×™×š ×¤×¨×•×˜×•×§×•×œ\t×›×¤×™×œ×•×ª\t×ª×¢×“×•×£\n' + 'â”€'.repeat(100) + '\n';
                staffMeetingTasks.forEach((task) => {
                    text += `${task.globalId}\t${task.section}\t${task.taskDescription}\t${task.responsible}\t${formatDateForDisplay(task.protocolDate)}\t${task.isDuplicate ? '×›×Ÿ' : '×œ×'}\t${getPriorityTextForCopy(task.priority)}\n`;
                });
            }

            if (managementTasks.length > 0) {
                text += '\n--- ×¡×™×›×•××™ ×™×©×™×‘×•×ª ×”× ×”×œ×” ---\n';
                text += '××¡\' ×›×œ×œ×™\t×¡×¢×™×£\t×”×—×œ×˜×”/×”××©×š ×˜×™×¤×•×œ\t××—×¨××™\t×œ×•×— ×–×× ×™×\t×ª××¨×™×š ×¤×¨×•×˜×•×§×•×œ\t×›×¤×™×œ×•×ª\t×ª×¢×“×•×£\n' + 'â”€'.repeat(110) + '\n';
                managementTasks.forEach((task) => {
                    text += `${task.globalId}\t${task.section}\t${task.taskDescription}\t${task.responsible}\t${task.timeline}\t${formatDateForDisplay(task.protocolDate)}\t${task.isDuplicate ? '×›×Ÿ' : '×œ×'}\t${getPriorityTextForCopy(task.priority)}\n`;
                });
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showSuccess('×”××©×™××•×ª ×©× ×‘×—×¨×•/×¡×•× × ×• ×”×•×¢×ª×§×•!'))
                .catch(err => { showError('×©×’×™××” ×‘×”×¢×ª×§×”: ' + err.message); legacyCopyToClipboard(text); });
            } else { legacyCopyToClipboard(text); }
        }

        function legacyCopyToClipboard(text) {
            const ta = document.createElement('textarea'); ta.value = text;
            ta.style.position='fixed'; ta.style.top='-9999px'; document.body.appendChild(ta);
            ta.focus(); ta.select();
            try {
                if(document.execCommand('copy')) showSuccess('×”××©×™××•×ª ×©× ×‘×—×¨×•/×¡×•× × ×• ×”×•×¢×ª×§×• (×©×™×˜×” ×™×©× ×”)!');
                else showError('×”×¢×ª×§×” × ×›×©×œ×” (×©×™×˜×” ×™×©× ×”).');
            } catch (err) { showError('×©×’×™××” ×‘×”×¢×ª×§×” (×©×™×˜×” ×™×©× ×”): ' + err.message); }
            document.body.removeChild(ta);
        }

        function exportToExcel() { 
            showDebug("exportToExcel function called.");
            let tasksForExport;
            if (selectedTaskGlobalIds.size > 0) {
                tasksForExport = allExtractedTasks.filter(task => selectedTaskGlobalIds.has(task.globalId));
                showDebug(`Exporting ${selectedTaskGlobalIds.size} selected tasks to CSV.`);
            } else {
                tasksForExport = getFilteredTasks();
                if (tasksForExport.length === 0) {
                    showError("××™×Ÿ ××©×™××•×ª ×œ×™×™×¦×•× (×œ× × ×‘×—×¨×• ××©×™××•×ª ×•×œ× ××•×¦×’×•×ª ××©×™××•×ª ××¡×•× × ×•×ª).");
                    showDebug("No tasks to export (neither selected nor filtered).");
                    return;
                }
                showDebug(`No tasks selected, exporting ${tasksForExport.length} currently displayed/filtered tasks to CSV.`);
            }
            
            showDebug("Creating CSV content...");
            const csvContent = createCSVContent(tasksForExport);
            showDebug("CSV content created. Length: " + csvContent.length);
            
            try {
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                showDebug("Blob created. Type: " + blob.type + ", Size: " + blob.size);
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                showDebug("Blob URL created: " + url);
                link.setAttribute('href', url);
                link.setAttribute('download', `××©×™××•×ª_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                showDebug("Link appended to body. Clicking link...");
                link.click();
                showDebug("Link clicked.");
                document.body.removeChild(link);
                showDebug("Link removed from body.");
                URL.revokeObjectURL(url); 
                showSuccess('×”××©×™××•×ª ×™×•×¦××• ×‘×”×¦×œ×—×” ×œ×§×•×‘×¥ CSV (× ×™×ª×Ÿ ×œ×¤×ª×•×— ×‘××§×¡×œ)!');
            } catch (e) {
                showError("×©×’×™××” ×‘×ª×”×œ×™×š ×™×™×¦×•× ×”×§×•×‘×¥: " + e.message);
                showDebug("Error during CSV export process: " + e.message + "\nStack: " + e.stack);
                console.error("Export error:", e);
            }
        }

        function createCSVContent(tasksToExport) { 
            showDebug("createCSVContent function called for " + tasksToExport.length + " tasks.");
            let csv = '××¡\' ×›×œ×œ×™,×¡×•×’ ××¡××š,× ×•×©×/×¡×¢×™×£,××©×™××”/×”×—×œ×˜×”,××—×¨××™,×œ×•×— ×–×× ×™×,×ª××¨×™×š ×¤×¨×•×˜×•×§×•×œ,×ª×¢×“×•×£,×›×¤×™×œ×•×ª\n';
            const getPriorityTextForCopy = (priorityLevel) => {
                const priorityKeys = ['×œ×œ×', '× ××•×š', '×‘×™× ×•× ×™', '×’×‘×•×”'];
                return priorityKeys[priorityLevel] || '×œ×œ×';
            }
            const escapeCSV = (field) => `"${String(field === undefined || field === null ? '' : field).replace(/"/g, '""')}"`;
            
            tasksToExport.forEach(task => {
                csv += `${task.globalId || ''},${escapeCSV(task.documentType)},${escapeCSV(task.section)},${escapeCSV(task.taskDescription)},${escapeCSV(task.responsible)},${escapeCSV(task.timeline)},${escapeCSV(formatDateForDisplay(task.protocolDate))},${escapeCSV(getPriorityTextForCopy(task.priority))},${escapeCSV(task.isDuplicate ? '×›×Ÿ' : '×œ×')}\n`;
            });
            showDebug("CSV content generation complete for export. First 100 chars: " + csv.substring(0,100));
            return csv;
        }

        function exportToJSON() {
            showDebug("exportToJSON function called.");
            let tasksForExport;
            if (selectedTaskGlobalIds.size > 0) {
                tasksForExport = allExtractedTasks.filter(task => selectedTaskGlobalIds.has(task.globalId));
                showDebug(`Exporting ${selectedTaskGlobalIds.size} selected tasks to JSON.`);
            } else {
                tasksForExport = getFilteredTasks();
                 if (tasksForExport.length === 0) {
                    showError("××™×Ÿ ××©×™××•×ª ×œ×™×™×¦×•× (×œ× × ×‘×—×¨×• ××©×™××•×ª ×•×œ× ××•×¦×’×•×ª ××©×™××•×ª ××¡×•× × ×•×ª).");
                    showDebug("No tasks to export for JSON (neither selected nor filtered).");
                    return;
                }
                showDebug(`No tasks selected, exporting ${tasksForExport.length} currently displayed/filtered tasks to JSON.`);
            }

            const dataToExport = {
                exportDate: new Date().toISOString(),
                totalTasksInSelection: tasksForExport.length,
                nextGlobalTaskId: nextGlobalTaskId, 
                tasks: tasksForExport 
            };
            showDebug("Data for JSON export prepared.");
            
            try {
                const jsonString = JSON.stringify(dataToExport, null, 2);
                showDebug("JSON string created. Length: " + jsonString.length);
                const blob = new Blob([jsonString], { type: 'application/json' });
                showDebug("JSON Blob created. Type: " + blob.type + ", Size: " + blob.size);
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                showDebug("JSON Blob URL created: " + url);
                link.setAttribute('href', url);
                link.setAttribute('download', `××©×™××•×ª_×‘×—×™×¨×”_${new Date().toISOString().split('T')[0]}.json`);
                document.body.appendChild(link);
                showDebug("JSON Link appended to body. Clicking link...");
                link.click();
                showDebug("JSON Link clicked.");
                document.body.removeChild(link);
                showDebug("JSON Link removed from body.");
                URL.revokeObjectURL(url);
                showSuccess('×”××©×™××•×ª ×©× ×‘×—×¨×•/×¡×•× × ×• × ×©××¨×• ×‘×”×¦×œ×—×” ×›×§×•×‘×¥ JSON!');
            } catch (e) {
                showError("×©×’×™××” ×‘×ª×”×œ×™×š ×™×™×¦×•× ×”-JSON: " + e.message);
                showDebug("Error during JSON export process: " + e.message + "\nStack: " + e.stack);
                console.error("JSON Export error:", e);
            }
        }

        function importFromJSON(event) {
            showDebug("importFromJSON function called.");
            const file = event.target.files[0];
            if (!file) {
                showDebug("No file selected for import.");
                return;
            }
            showDebug(`Importing file: ${file.name}`);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    showDebug("File read. Parsing JSON...");
                    const data = JSON.parse(e.target.result);
                    if (data.tasks && Array.isArray(data.tasks)) {
                        showDebug(`JSON parsed. Found ${data.tasks.length} tasks in file.`);
                        
                        const importedTasks = data.tasks.map(task => {
                            task.globalId = nextGlobalTaskId++; 
                            task.priority = task.priority !== undefined ? task.priority : PRIORITY_LEVELS.NONE;
                            task.isDuplicate = task.isDuplicate !== undefined ? task.isDuplicate : false; 
                            task.documentType = task.documentType || "×œ× ×™×“×•×¢";
                            task.protocolDate = task.protocolDate || "×œ× ×™×“×•×¢";
                            task.timeline = task.timeline || "×œ× ×¦×•×™×Ÿ";
                            task.section = task.section || "";
                            task.responsible = task.responsible || "×œ× ×¦×•×™×Ÿ";
                            return task;
                        });
                        
                        allExtractedTasks.push(...importedTasks);
                        
                        if (data.nextGlobalTaskId && data.nextGlobalTaskId > nextGlobalTaskId) {
                            nextGlobalTaskId = data.nextGlobalTaskId;
                             showDebug(`nextGlobalTaskId updated to ${nextGlobalTaskId} from imported file.`);
                        }
                        
                        identifyAndMarkDuplicates();
                        saveTasksToLocalStorage();
                        updateStatistics();
                        populateFilterOptions();
                        displayResults(allExtractedTasks); 
                        
                        showSuccess(`${importedTasks.length} ××©×™××•×ª × ×˜×¢× ×• ×•×”×ª×•×•×¡×¤×• ×œ×¨×©×™××”!`);
                    } else {
                        showError("×”×§×•×‘×¥ ×œ× ××›×™×œ ××©×™××•×ª ×‘×¤×•×¨××˜ ×ª×§×™×Ÿ.");
                        showDebug("Invalid JSON format: 'tasks' array not found or not an array.");
                    }
                } catch (err) {
                    showError("×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: " + err.message);
                    showDebug("Error parsing JSON from file: " + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = null; 
        }

        function saveTasksToLocalStorage() {
            try {
                localStorage.setItem('savedTasks', JSON.stringify(allExtractedTasks));
                localStorage.setItem('nextGlobalTaskId', nextGlobalTaskId.toString());
                localStorage.setItem('lastProcessedFileNames', JSON.stringify(lastProcessedFileNames));
                localStorage.setItem('selectedTaskGlobalIds', JSON.stringify(Array.from(selectedTaskGlobalIds))); 
                showDebug("Tasks saved to localStorage.");
            } catch (e) {
                showError("×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™× ×œ×“×¤×“×¤×Ÿ. ×™×™×ª×›×Ÿ ×•×”××—×¡×•×Ÿ ××œ×.");
                console.error("Error saving to localStorage:", e);
            }
        }

        function loadTasksFromLocalStorage() {
            try {
                const saved = localStorage.getItem('savedTasks');
                const savedNextId = localStorage.getItem('nextGlobalTaskId');
                const savedFileNames = localStorage.getItem('lastProcessedFileNames');
                const savedSelectedIds = localStorage.getItem('selectedTaskGlobalIds');


                if (saved) {
                    allExtractedTasks = JSON.parse(saved);
                    allExtractedTasks.forEach(task => {
                        if (task.priority === undefined) {
                            task.priority = PRIORITY_LEVELS.NONE;
                        }
                    });
                    nextGlobalTaskId = savedNextId ? parseInt(savedNextId) : (allExtractedTasks.length > 0 ? Math.max(...allExtractedTasks.map(t => t.globalId || 0)) + 1 : 1);
                    lastProcessedFileNames = savedFileNames ? JSON.parse(savedFileNames) : [];
                    selectedTaskGlobalIds = savedSelectedIds ? new Set(JSON.parse(savedSelectedIds)) : new Set();

                    
                    if (allExtractedTasks.length > 0) {
                        identifyAndMarkDuplicates();
                        updateStatistics();
                        populateFilterOptions();
                        displayResults(allExtractedTasks);
                        showSuccess(`${allExtractedTasks.length} ××©×™××•×ª × ×˜×¢× ×• ××”××—×¡×•×Ÿ ×”××§×•××™.`);
                    }
                }
            } catch (e) {
                showError("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ××”××—×¡×•×Ÿ ×”××§×•××™.");
                console.error("Error loading from localStorage:", e);
                localStorage.removeItem('savedTasks');
                localStorage.removeItem('nextGlobalTaskId');
                localStorage.removeItem('lastProcessedFileNames');
                localStorage.removeItem('selectedTaskGlobalIds');
            }
        }


        function switchToUploadView() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('filtersSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('processing').style.display = 'none';
            if (fileInput) fileInput.value = '';
            hideMessages();
            document.getElementById('debugSection').style.display = 'none';
            document.getElementById('debugContent').textContent = '';
        }

        function showProcessing() {
            document.getElementById('processing').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('filtersSection').style.display = 'none';
            processingMessageElement.textContent = '××ª×—×™×œ ×¢×™×‘×•×“...';
        }

        function hideProcessing() {
            document.getElementById('processing').style.display = 'none';
            processingMessageElement.textContent = '';
        }
        
        function showError(message) { 
            const el = document.getElementById('errorMessage'); 
            el.textContent = message; 
            el.style.display = 'block'; 
        }
        
        function showSuccess(message) { 
            const el = document.getElementById('successMessage'); 
            el.textContent = message; 
            el.style.display = 'block'; 
            setTimeout(() => el.style.display = 'none', 5000); 
        }
        
        function showDebug(message) {
            const ds = document.getElementById('debugSection');
            const dc = document.getElementById('debugContent');
            ds.style.display = 'block';
            dc.textContent += message + '\n'; 
            console.log("DEBUG: " + message);
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTasksFromLocalStorage(); 
            hideMessages();
            document.getElementById('debugSection').style.display = 'none';
            document.getElementById('debugContent').textContent = '';
            updateStatistics(); 
        });
    </script>
</body>
</html>
